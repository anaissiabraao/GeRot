{% extends "base_tailwind.html" %}

{% block title %}Gerenciar Usuários - GeRot Admin{% endblock %}

{% block content %}
<div class="min-h-screen bg-background">
    <!-- Header com Navegação -->
    <header class="border-b bg-card shadow-sm">
        <div class="container mx-auto px-4">
            <div class="flex h-16 items-center justify-between">
                <div class="flex items-center space-x-4">
                    <!-- Logo -->
                    <div class="flex items-center gap-2">
                        <img src="{{ url_for('static', filename='portoex-logo.png') }}" alt="PortoEx" class="h-8 w-auto">
                        <span class="text-xl font-bold text-primary border-l border-muted-foreground/30 pl-2 ml-2">GeRot</span>
                    </div>
                    
                    <nav class="hidden md:flex space-x-1">
                        <a href="{{ url_for('admin_dashboard') }}" class="rounded-md px-3 py-2 text-sm font-medium text-foreground hover:bg-accent hover:text-accent-foreground transition-colors">
                            <i class="fas fa-arrow-left mr-2"></i>Voltar ao Painel
                        </a>
                    </nav>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-muted-foreground">
                        {{ session.nome_completo }}
                    </span>
                    <a href="{{ url_for('logout') }}" class="rounded-md bg-destructive px-3 py-2 text-sm font-medium text-white hover:bg-destructive/90 transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div class="mb-8 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
            <div>
                <h1 class="flex items-center gap-3 text-2xl font-bold text-foreground">
                    <i class="fas fa-users text-primary"></i>
                    Gerenciar Usuários
                </h1>
                <p class="mt-1 text-sm text-muted-foreground">Administre as contas de acesso ao sistema</p>
            </div>
            <button onclick="openAddModal()" class="inline-flex items-center rounded-md bg-green-600 px-4 py-2 text-sm font-medium text-white shadow-sm transition-colors hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                <i class="fas fa-plus mr-2"></i> Adicionar Usuário
            </button>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mb-6 space-y-4">
                    {% for category, message in messages %}
                        <div class="rounded-lg border px-4 py-3 shadow-sm {% if category == 'success' %}bg-green-50 border-green-200 text-green-800{% elif category == 'error' %}bg-red-50 border-red-200 text-red-800{% else %}bg-blue-50 border-blue-200 text-blue-800{% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Filtros -->
        <div class="mb-6 rounded-xl border bg-card p-4 shadow-sm">
            <div class="grid gap-4 md:grid-cols-3">
                <div class="space-y-1">
                    <label for="search" class="text-xs font-medium text-muted-foreground uppercase">Buscar</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-muted-foreground">
                            <i class="fas fa-search"></i>
                        </div>
                        <input type="text" id="search" placeholder="Nome, email ou usuário..."
                               class="w-full rounded-md border bg-background pl-10 pr-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary">
                    </div>
                </div>
                <div class="space-y-1">
                    <label for="role_filter" class="text-xs font-medium text-muted-foreground uppercase">Role</label>
                    <select id="role_filter" class="w-full rounded-md border bg-background px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary">
                        <option value="">Todos</option>
                        <option value="admin">Admin</option>
                        <option value="usuario">Usuário</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label for="status_filter" class="text-xs font-medium text-muted-foreground uppercase">Status</label>
                    <select id="status_filter" class="w-full rounded-md border bg-background px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary">
                        <option value="">Todos</option>
                        <option value="true">Ativo</option>
                        <option value="false">Inativo</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Tabela -->
        <div class="rounded-xl border bg-card shadow-sm overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-muted/50 border-b">
                        <tr>
                            <th class="px-6 py-3 font-medium text-muted-foreground uppercase tracking-wider">Usuário</th>
                            <th class="px-6 py-3 font-medium text-muted-foreground uppercase tracking-wider">Email / Login</th>
                            <th class="px-6 py-3 font-medium text-muted-foreground uppercase tracking-wider">Role</th>
                            <th class="px-6 py-3 font-medium text-muted-foreground uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 font-medium text-muted-foreground uppercase tracking-wider text-right">Ações</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-border bg-card">
                        {% for user in users %}
                        <tr class="transition-colors hover:bg-muted/30">
                            <td class="px-6 py-4">
                                <div class="font-medium text-foreground">{{ user.nome_completo }}</div>
                                {% if user.cargo_original or user.departamento %}
                                <div class="text-xs text-muted-foreground">
                                    {{ user.cargo_original }} {% if user.cargo_original and user.departamento %}-{% endif %} {{ user.departamento }}
                                </div>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-foreground">{{ user.email or '-' }}</div>
                                <div class="text-xs text-muted-foreground font-mono">{{ user.nome_usuario or '-' }}</div>
                            </td>
                            <td class="px-6 py-4">
                                {% if user.role == 'admin' %}
                                    <span class="inline-flex items-center rounded-full bg-purple-100 px-2.5 py-0.5 text-xs font-medium text-purple-800">
                                        Admin
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-800">
                                        Usuário
                                    </span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex flex-col gap-1">
                                    {% if user.is_active %}
                                        <span class="inline-flex w-fit items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800">
                                            Ativo
                                        </span>
                                    {% else %}
                                        <span class="inline-flex w-fit items-center rounded-full bg-red-100 px-2.5 py-0.5 text-xs font-medium text-red-800">
                                            Inativo
                                        </span>
                                    {% endif %}
                                    
                                    {% if user.first_login %}
                                        <span class="text-xs text-amber-600 flex items-center gap-1">
                                            <i class="fas fa-exclamation-circle"></i> Primeiro Acesso
                                        </span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <div class="flex items-center justify-end gap-2">
                                    <button onclick="openEditModal({{ user.id }}, '{{ user.email or '' }}', '{{ user.nome_usuario or '' }}', '{{ user.role }}', {{ 'true' if user.first_login else 'false' }}, '{{ user.nome_completo|replace("'", "\\'") }}', '{{ user.cargo_original or '' }}', '{{ user.departamento or '' }}', {{ 'true' if user.is_active else 'false' }})" 
                                            class="rounded-md p-2 text-muted-foreground hover:bg-accent hover:text-accent-foreground transition-colors" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    
                                    {% if user.id != session.user_id %}
                                    <form method="POST" action="{{ url_for('delete_user', user_id=user.id) }}" class="inline-block" onsubmit="return confirm('Tem certeza que deseja desativar este usuário?');">
                                        <button type="submit" class="rounded-md p-2 text-muted-foreground hover:bg-destructive/10 hover:text-destructive transition-colors" title="Desativar">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<!-- Modal Adicionar -->
<div id="addModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
    <div class="w-full max-w-lg rounded-xl bg-card shadow-xl animate-scale-in max-h-[90vh] flex flex-col">
        <div class="flex items-center justify-between border-b p-6">
            <h3 class="text-xl font-bold text-foreground">Adicionar Usuário</h3>
            <button onclick="closeAddModal()" class="text-muted-foreground hover:text-foreground">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6">
            <form id="addForm" method="POST" action="{{ url_for('add_user') }}" class="space-y-4">
                <div class="space-y-2">
                    <label class="text-sm font-medium text-foreground">Nome Completo</label>
                    <input type="text" name="nome_completo" required
                           class="w-full rounded-md border bg-background px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary">
                </div>
                
                <div class="grid gap-4 sm:grid-cols-2">
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-foreground">Email</label>
                        <input type="email" name="email" placeholder="@portoex.com.br" required
                               class="w-full rounded-md border bg-background px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-foreground">Usuário (opcional)</label>
                        <input type="text" name="nome_usuario"
                               class="w-full rounded-md border bg-background px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary">
                    </div>
                </div>
                
                <div class="grid gap-4 sm:grid-cols-2">
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-foreground">Role</label>
                        <select name="role" required
                                class="w-full rounded-md border bg-background px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary">
                            <option value="usuario">Usuário</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-foreground">Senha</label>
                        <input type="password" name="password" placeholder="Padrão: portoex123"
                               class="w-full rounded-md border bg-background px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary">
                    </div>
                </div>
                
                <div class="grid gap-4 sm:grid-cols-2">
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-foreground">Departamento</label>
                        <input type="text" name="departamento"
                               class="w-full rounded-md border bg-background px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-foreground">Cargo</label>
                        <input type="text" name="cargo_original"
                               class="w-full rounded-md border bg-background px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary">
                    </div>
                </div>
            </form>
        </div>
        
        <div class="border-t p-6 flex justify-end gap-3">
            <button onclick="closeAddModal()" class="rounded-lg border bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground">
                Cancelar
            </button>
            <button form="addForm" type="submit" class="rounded-lg bg-green-600 px-4 py-2 text-sm font-medium text-white shadow-sm transition-colors hover:bg-green-700">
                Adicionar
            </button>
        </div>
    </div>
</div>

<!-- Modal Editar -->
<div id="editModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
    <div class="w-full max-w-lg rounded-xl bg-card shadow-xl animate-scale-in max-h-[90vh] flex flex-col">
        <div class="flex items-center justify-between border-b p-6">
            <h3 class="text-xl font-bold text-foreground">Editar Usuário</h3>
            <button onclick="closeEditModal()" class="text-muted-foreground hover:text-foreground">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6">
            <form id="editForm" method="POST" class="space-y-4">
                <div class="space-y-2">
                    <label class="text-sm font-medium text-foreground">Nome Completo</label>
                    <input type="text" id="edit_nome_completo" name="nome_completo" required
                           class="w-full rounded-md border bg-background px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary">
                </div>
                
                <div class="grid gap-4 sm:grid-cols-2">
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-foreground">Cargo</label>
                        <input type="text" id="edit_cargo_original" name="cargo_original"
                               class="w-full rounded-md border bg-background px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-foreground">Departamento</label>
                        <input type="text" id="edit_departamento" name="departamento"
                               class="w-full rounded-md border bg-background px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary">
                    </div>
                </div>
                
                <div class="grid gap-4 sm:grid-cols-2">
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-foreground">Email</label>
                        <input type="email" id="email" name="email" required
                               class="w-full rounded-md border bg-background px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-foreground">Usuário</label>
                        <input type="text" id="nome_usuario" name="nome_usuario"
                               class="w-full rounded-md border bg-background px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary">
                    </div>
                </div>
                
                <div class="grid gap-4 sm:grid-cols-2">
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-foreground">Role</label>
                        <select id="role" name="role" required
                                class="w-full rounded-md border bg-background px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary">
                            <option value="usuario">Usuário</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-foreground">Status</label>
                        <select id="edit_is_active" name="is_active"
                                class="w-full rounded-md border bg-background px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary">
                            <option value="true">Ativo</option>
                            <option value="false">Inativo</option>
                        </select>
                    </div>
                </div>
                
                <div class="space-y-2">
                    <label class="text-sm font-medium text-foreground">Nova Senha</label>
                    <input type="password" id="password" name="password" placeholder="Deixe em branco para manter"
                           class="w-full rounded-md border bg-background px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary">
                </div>
                
                <div class="flex items-center gap-2 pt-2">
                    <input type="checkbox" id="reset_first_login" name="reset_first_login" class="h-4 w-4 rounded border-border text-primary focus:ring-primary">
                    <label for="reset_first_login" class="text-sm font-medium text-foreground">Resetar primeiro acesso (força troca de senha)</label>
                </div>
            </form>
        </div>
        
        <div class="border-t p-6 flex justify-end gap-3">
            <button onclick="closeEditModal()" class="rounded-lg border bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground">
                Cancelar
            </button>
            <button form="editForm" type="submit" class="rounded-lg bg-primary px-4 py-2 text-sm font-medium text-white shadow-sm transition-colors hover:bg-primary/90">
                Salvar Alterações
            </button>
        </div>
    </div>
</div>

<script>
    function openAddModal() {
        document.getElementById('addModal').classList.remove('hidden');
        document.getElementById('addModal').classList.add('flex');
    }

    function closeAddModal() {
        document.getElementById('addModal').classList.add('hidden');
        document.getElementById('addModal').classList.remove('flex');
    }

    function openEditModal(userId, email, nomeUsuario, role, firstLogin, nomeCompleto, cargo, departamento, isActive) {
        document.getElementById('editForm').action = `/admin/users/${userId}/update`;
        document.getElementById('email').value = email || '';
        document.getElementById('nome_usuario').value = nomeUsuario || '';
        document.getElementById('role').value = role || 'usuario';
        document.getElementById('password').value = '';
        document.getElementById('reset_first_login').checked = false;
        
        document.getElementById('edit_nome_completo').value = nomeCompleto || '';
        document.getElementById('edit_cargo_original').value = cargo || '';
        document.getElementById('edit_departamento').value = departamento || '';
        document.getElementById('edit_is_active').value = isActive ? 'true' : 'false';

        document.getElementById('editModal').classList.remove('hidden');
        document.getElementById('editModal').classList.add('flex');
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
        document.getElementById('editModal').classList.remove('flex');
    }

    // Filtros
    document.getElementById('search').addEventListener('input', filterTable);
    document.getElementById('role_filter').addEventListener('change', filterTable);
    document.getElementById('status_filter').addEventListener('change', filterTable);

    function filterTable() {
        const search = document.getElementById('search').value.toLowerCase();
        const roleFilter = document.getElementById('role_filter').value;
        const statusFilter = document.getElementById('status_filter').value;
        
        const rows = document.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            const nome = row.cells[0].textContent.toLowerCase();
            const email = row.cells[1].textContent.toLowerCase();
            const role = row.cells[2].textContent.toLowerCase();
            const status = row.cells[3].textContent.toLowerCase();
            
            const matchesSearch = nome.includes(search) || email.includes(search);
            const matchesRole = !roleFilter || role.includes(roleFilter);
            const matchesStatus = !statusFilter || 
                (statusFilter === 'true' && status.includes('ativo')) ||
                (statusFilter === 'false' && status.includes('inativo'));
            
            if (matchesSearch && matchesRole && matchesStatus) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
</script>
{% endblock %}
