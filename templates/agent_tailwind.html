{% extends "base_tailwind.html" %}

{% block title %}Agente{% endblock %}

{% block scripts %}
<!-- SheetJS para Exportação Excel -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-background">
    <!-- Header com Navegação -->
    <header class="border-b bg-card shadow-sm">
        <div class="container mx-auto px-4">
            <div class="flex h-16 items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center gap-2">
                        <img src="{{ url_for('static', filename='portoex-logo.png') }}" alt="PortoEx" class="h-8 w-auto">
                        <span class="text-xl font-bold text-primary border-l border-muted-foreground/30 pl-2 ml-2">GeRot</span>
                    </div>
                    <nav class="flex flex-wrap space-x-1">
                        <a href="{{ url_for('index') }}" class="rounded-md px-3 py-2 text-sm font-medium text-foreground hover:bg-accent hover:text-accent-foreground transition-colors">
                            <i class="fas fa-home mr-2"></i>Início
                        </a>
                        <a href="{{ url_for('team_dashboard') }}" class="rounded-md px-3 py-2 text-sm font-medium text-foreground hover:bg-accent hover:text-accent-foreground transition-colors">
                            <i class="fas fa-chart-bar mr-2"></i>Dashboards
                        </a>
                        <a href="{{ url_for('cd_booking') }}" class="rounded-md px-3 py-2 text-sm font-medium text-foreground hover:bg-accent hover:text-accent-foreground transition-colors">
                            <i class="fas fa-calendar mr-2"></i>Agenda CD
                        </a>
                        {% if session.role == 'admin' %}
                        <a href="{{ url_for('admin_dashboard') }}" class="rounded-md px-3 py-2 text-sm font-medium text-foreground hover:bg-accent hover:text-accent-foreground transition-colors">
                            <i class="fas fa-cog mr-2"></i>Admin
                        </a>
                        {% endif %}
                    </nav>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-muted-foreground">
                        Olá, {{ session.nome_completo }}
                    </span>
                    <a href="{{ url_for('profile') }}" class="rounded-md px-3 py-2 text-sm font-medium text-foreground hover:bg-accent hover:text-accent-foreground transition-colors">
                        <i class="fas fa-user-circle"></i>
                    </a>
                    <a href="{{ url_for('logout') }}" class="rounded-md bg-destructive px-3 py-2 text-sm font-medium text-white hover:bg-destructive/90 transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>Sair
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container mx-auto px-4 py-4">
                {% for category, message in messages %}
                    <div class="mb-4 rounded-lg border px-4 py-3 {% if category == 'success' %}bg-green-50 border-green-200 text-green-800{% elif category == 'error' %}bg-red-50 border-red-200 text-red-800{% else %}bg-orange-50 border-orange-200 text-orange-800{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Conteúdo Principal -->
    <main class="container mx-auto px-4 py-8">
        <!-- Título e Descrição -->
        <div class="mb-8">
            <div class="flex items-center gap-3 mb-2">
                <div class="rounded-full bg-gradient-to-br from-purple-500 to-indigo-600 p-3">
                    <i class="fas fa-robot text-white text-2xl"></i>
                </div>
                <div>
                    <h2 class="text-3xl font-bold text-foreground">Agente IA</h2>
                    <p class="text-muted-foreground">
                        Automação inteligente e geração de relatórios
                    </p>
                </div>
            </div>
        </div>

        <!-- Tabs de Navegação -->
        <div class="mb-6">
            <div class="border-b border-border">
                <nav class="flex flex-wrap gap-2 sm:gap-0 sm:space-x-8" aria-label="Tabs">
                    <button onclick="switchTab('rpa')" id="tab-rpa" 
                            class="tab-button border-b-2 border-transparent py-4 px-1 text-sm font-medium text-muted-foreground hover:text-foreground hover:border-muted-foreground">
                        <i class="fas fa-cogs mr-2"></i>RPA - Automação
                    </button>
                    <button onclick="switchTab('chat')" id="tab-chat" 
                            class="tab-button border-b-2 border-transparent py-4 px-1 text-sm font-medium text-muted-foreground hover:text-foreground hover:border-muted-foreground">
                        <i class="fas fa-comments mr-2"></i>Chat IA
                    </button>
                    {% if session.role == 'admin' %}
                    <button onclick="switchTab('knowledge')" id="tab-knowledge" 
                            class="tab-button border-b-2 border-transparent py-4 px-1 text-sm font-medium text-muted-foreground hover:text-foreground hover:border-muted-foreground">
                        <i class="fas fa-book mr-2"></i>Base de Conhecimento
                    </button>
                    {% endif %}
                    <button onclick="switchTab('dashboard')" id="tab-dashboard" 
                            class="tab-button border-b-2 border-transparent py-4 px-1 text-sm font-medium text-muted-foreground hover:text-foreground hover:border-muted-foreground">
                        <i class="fas fa-chart-pie mr-2"></i>Gerar Dashboard
                    </button>
                    <button onclick="switchTab('my-dashboards')" id="tab-my-dashboards" 
                            class="tab-button border-b-2 border-transparent py-4 px-1 text-sm font-medium text-muted-foreground hover:text-foreground hover:border-muted-foreground">
                        <i class="fas fa-th-large mr-2"></i>Meus Dashboards
                    </button>
                    <button onclick="switchTab('executables')" id="tab-executables" 
                            class="tab-button border-b-2 border-transparent py-4 px-1 text-sm font-medium text-muted-foreground hover:text-foreground hover:border-muted-foreground">
                        <i class="fas fa-play-circle mr-2"></i>Executáveis
                    </button>
                    <button onclick="switchTab('auditoria')" id="tab-auditoria" 
                            class="tab-button border-b-2 border-primary py-4 px-1 text-sm font-medium text-primary">
                        <i class="fas fa-search-dollar mr-2"></i>Auditoria Fiscal
                    </button>
                </nav>
            </div>
        </div>

        <!-- Conteúdo da Tab RPA -->
        <div id="content-rpa" class="tab-content hidden">
            <div class="grid gap-6 lg:grid-cols-3">
                <!-- Formulário de Criação de RPA -->
                <div class="lg:col-span-2">
                    <div class="rounded-lg border bg-card shadow-sm">
                        <div class="border-b px-6 py-4">
                            <h3 class="flex items-center gap-2 text-lg font-semibold">
                                <i class="fas fa-plus-circle text-primary"></i>
                                Criar Nova Automação RPA
                            </h3>
                        </div>
                        <div class="p-6">
                            <form id="rpaForm" onsubmit="submitRPA(event)">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-foreground mb-1">
                                            Nome da Automação *
                                        </label>
                                        <input type="text" name="name" required
                                               class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary"
                                               placeholder="Ex: Extração de dados do ERP">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-foreground mb-1">
                                            Descrição *
                                        </label>
                                        <textarea name="description" rows="3" required
                                                  class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary"
                                                  placeholder="Descreva o que esta automação deve fazer..."></textarea>
                                    </div>
                                    
                                    <div class="grid gap-4 md:grid-cols-2">
                                        <div>
                                            <label class="block text-sm font-medium text-foreground mb-1">
                                                Tipo de Automação *
                                            </label>
                                            <select name="rpa_type" required
                                                    class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                                                <option value="">Selecione...</option>
                                                {% for tipo in rpa_types %}
                                                <option value="{{ tipo.id }}">{{ tipo.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-foreground mb-1">
                                                Prioridade *
                                            </label>
                                            <select name="priority" required
                                                    class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                                                <option value="low">Baixa</option>
                                                <option value="medium" selected>Média</option>
                                                <option value="high">Alta</option>
                                                <option value="critical">Crítica</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-foreground mb-1">
                                            Frequência de Execução
                                        </label>
                                        <select name="frequency"
                                                class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                                            <option value="once">Uma vez</option>
                                            <option value="daily">Diário</option>
                                            <option value="weekly">Semanal</option>
                                            <option value="monthly">Mensal</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-foreground mb-1">
                                            Parâmetros Adicionais (JSON)
                                        </label>
                                        <textarea name="parameters" rows="3"
                                                  class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-primary"
                                                  placeholder='{"url": "https://...", "campos": ["nome", "valor"]}'></textarea>
                                    </div>
                                </div>
                                
                                <div class="mt-6 flex justify-end gap-3">
                                    <button type="reset" class="rounded-md border border-input bg-background px-4 py-2 text-sm font-medium hover:bg-accent transition-colors">
                                        Limpar
                                    </button>
                                    <button type="submit" class="rounded-md bg-primary px-4 py-2 text-sm font-medium text-white hover:bg-primary/90 transition-colors">
                                        <i class="fas fa-paper-plane mr-2"></i>
                                        Criar Automação
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Sidebar com Informações -->
                <div class="space-y-6">
                    <!-- Status das Automações -->
                    <div class="rounded-lg border bg-card shadow-sm">
                        <div class="border-b px-6 py-4">
                            <h3 class="flex items-center gap-2 text-lg font-semibold">
                                <i class="fas fa-tasks text-primary"></i>
                                Status
                            </h3>
                        </div>
                        <div class="p-6 space-y-4">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-muted-foreground">Pendentes</span>
                                <span class="rounded-full bg-amber-100 px-2.5 py-0.5 text-xs font-medium text-amber-800">
                                    {{ stats.pending }}
                                </span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-muted-foreground">Em Execução</span>
                                <span class="rounded-full bg-blue-100 px-2.5 py-0.5 text-xs font-medium text-blue-800">
                                    {{ stats.running }}
                                </span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-muted-foreground">Concluídas</span>
                                <span class="rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800">
                                    {{ stats.completed }}
                                </span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-muted-foreground">Com Erro</span>
                                <span class="rounded-full bg-red-100 px-2.5 py-0.5 text-xs font-medium text-red-800">
                                    {{ stats.failed }}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tipos de RPA Disponíveis -->
                    <div class="rounded-lg border bg-card shadow-sm">
                        <div class="border-b px-6 py-4">
                            <h3 class="flex items-center gap-2 text-lg font-semibold">
                                <i class="fas fa-list text-primary"></i>
                                Tipos Disponíveis
                            </h3>
                        </div>
                        <div class="p-4">
                            <ul class="space-y-2">
                                {% for tipo in rpa_types %}
                                <li class="flex items-center gap-2 text-sm">
                                    <i class="fas fa-check-circle text-green-500"></i>
                                    {{ tipo.name }}
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Lista de RPAs Recentes -->
            <div class="mt-8 rounded-lg border bg-card shadow-sm">
                <div class="border-b px-6 py-4">
                    <h3 class="flex items-center gap-2 text-lg font-semibold">
                        <i class="fas fa-history text-primary"></i>
                        Automações Recentes
                    </h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-muted/50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-muted-foreground">Nome</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-muted-foreground">Tipo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-muted-foreground">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-muted-foreground">Criado em</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-muted-foreground">Ações</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-border">
                            {% for rpa in rpas %}
                            <tr class="hover:bg-muted/30">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">{{ rpa.name }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-muted-foreground">{{ rpa.type_name }}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="rounded-full px-2.5 py-0.5 text-xs font-medium
                                        {% if rpa.status == 'pending' %}bg-amber-100 text-amber-800
                                        {% elif rpa.status == 'running' %}bg-blue-100 text-blue-800
                                        {% elif rpa.status == 'completed' %}bg-green-100 text-green-800
                                        {% else %}bg-red-100 text-red-800{% endif %}">
                                        {{ rpa.status }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-muted-foreground">{{ rpa.created_at }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    {% if rpa.status != 'running' %}
                                    <button onclick="executeRPA({{ rpa.id }})" class="text-green-600 hover:underline mr-2" title="Executar">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    {% else %}
                                    <span class="text-blue-500 mr-2" title="Em execução">
                                        <i class="fas fa-spinner fa-spin"></i>
                                    </span>
                                    {% endif %}
                                    {% if rpa.status == 'completed' and rpa.result %}
                                    <a href="{{ url_for('export_rpa_to_excel', rpa_id=rpa.id) }}" class="text-green-700 hover:underline mr-2" title="Exportar Excel">
                                        <i class="fas fa-file-excel"></i>
                                    </a>
                                    {% endif %}
                                    <a href="{{ url_for('view_rpa_page', rpa_id=rpa.id) }}" class="text-primary hover:underline mr-2" title="Ver Detalhes">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <button onclick="viewRPALogs({{ rpa.id }})" class="text-blue-500 hover:underline mr-2" title="Ver Logs">
                                        <i class="fas fa-file-alt"></i>
                                    </button>
                                    <button onclick="deleteRPA({{ rpa.id }})" class="text-destructive hover:underline" title="Excluir">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="px-6 py-8 text-center text-muted-foreground">
                                    <i class="fas fa-inbox text-4xl mb-2"></i>
                                    <p>Nenhuma automação criada ainda</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Conteúdo da Tab Chat IA -->
        <div id="content-chat" class="tab-content hidden h-[calc(100vh-250px)] min-h-[500px]">
            <div class="grid h-full grid-cols-1 gap-6 lg:grid-cols-4">
                <!-- Sidebar Histórico -->
                <div class="hidden lg:flex lg:flex-col rounded-lg border bg-card shadow-sm overflow-hidden">
                    <div class="border-b px-4 py-3 bg-muted/30">
                        <button onclick="startNewChat()" class="w-full flex items-center justify-center gap-2 rounded-md bg-primary px-3 py-2 text-sm font-medium text-white hover:bg-primary/90 transition-colors">
                            <i class="fas fa-plus"></i> Novo Chat
                        </button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-2 space-y-1" id="chat-history-list">
                        <!-- Chats serão carregados aqui via JS -->
                        <div class="text-center py-4 text-muted-foreground text-sm">
                            Carregando histórico...
                        </div>
                    </div>
                </div>

                <!-- Área Principal do Chat -->
                <div class="lg:col-span-3 flex flex-col rounded-lg border bg-card shadow-sm overflow-hidden relative">
                    <!-- Header do Chat -->
                    <div class="border-b px-6 py-3 flex items-center justify-between bg-white/50 backdrop-blur-sm">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-primary/5 p-1">
                                <img src="{{ url_for('static', filename='logo-IA.png') }}" alt="IA" class="w-full h-full object-contain">
                            </div>
                            <h3 class="font-semibold text-foreground">
                                <span id="current-chat-title">Novo Chat</span>
                            </h3>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-muted-foreground hidden sm:inline-block">
                                <i class="fas fa-info-circle mr-1"></i>
                                As respostas são geradas por IA.
                            </span>
                        </div>
                    </div>

                    <!-- Mensagens -->
                    <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50/50" id="chat-messages">
                        <!-- Mensagem de boas vindas -->
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 rounded-full bg-white border border-gray-200 flex items-center justify-center flex-shrink-0 overflow-hidden shadow-sm p-1">
                                <img src="{{ url_for('static', filename='avatar-bot.png') }}" alt="AI" class="w-full h-full object-contain">
                            </div>
                            <div class="rounded-2xl p-4 text-sm max-w-[85%] bg-white border border-gray-100 text-gray-800 rounded-tl-sm shadow-sm">
                                <p>Olá! Sou o assistente virtual do GeRot. Como posso ajudar você hoje com seus dados e relatórios?</p>
                            </div>
                        </div>
                    </div>

                    <!-- Ações Rápidas -->
                    <div class="px-4 py-2 border-t bg-muted/20 flex gap-2 overflow-x-auto">
                        <button type="button" onclick="insertCommand('/solicitar ')" 
                                class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-blue-100 text-blue-700 text-xs font-medium hover:bg-blue-200 transition-colors whitespace-nowrap">
                            <i class="fas fa-database"></i> Solicitar Dados
                        </button>
                        <button type="button" onclick="exportChatToExcel()" 
                                class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-green-100 text-green-700 text-xs font-medium hover:bg-green-200 transition-colors whitespace-nowrap">
                            <i class="fas fa-file-excel"></i> Exportar Chat
                        </button>
                    </div>

                    <!-- Input -->
                    <div class="border-t p-4 bg-background">
                        <form id="chatForm" onsubmit="sendMessage(event)" class="relative">
                            <div class="relative flex items-end gap-2">
                                <textarea name="message" id="chat-input" rows="1" 
                                          class="flex-1 min-h-[44px] max-h-[150px] w-full rounded-md border border-input bg-background px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary resize-none"
                                          placeholder="Digite sua mensagem..."
                                          onkeydown="handleChatKeydown(event)"></textarea>
                                <button type="submit" id="send-btn"
                                        class="h-[44px] w-[44px] rounded-md bg-primary text-white hover:bg-primary/90 transition-colors flex items-center justify-center flex-shrink-0 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conteúdo da Tab Base de Conhecimento -->
        <div id="content-knowledge" class="tab-content hidden h-[calc(100vh-250px)] min-h-[500px]">
            <div class="grid h-full grid-cols-1 gap-6 lg:grid-cols-3">
                <!-- Lista de Conhecimento -->
                <div class="lg:col-span-2 flex flex-col rounded-lg border bg-card shadow-sm overflow-hidden">
                    <div class="border-b px-6 py-4 flex justify-between items-center">
                        <h3 class="font-semibold flex items-center gap-2">
                            <i class="fas fa-book text-primary"></i>
                            Itens de Conhecimento
                        </h3>
                        <div class="relative">
                            <input type="text" id="knowledge-search" onkeyup="filterKnowledge()" placeholder="Buscar..." 
                                   class="pl-8 pr-3 py-1 text-sm rounded-md border border-input bg-background focus:outline-none focus:ring-1 focus:ring-primary w-48">
                            <i class="fas fa-search absolute left-2.5 top-2 text-xs text-muted-foreground"></i>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 space-y-3" id="knowledge-list">
                        <div class="text-center py-8 text-muted-foreground">Carregando...</div>
                    </div>
                </div>

                <!-- Formulário de Adição -->
                <div class="rounded-lg border bg-card shadow-sm h-fit">
                    <div class="border-b px-6 py-4">
                        <h3 class="font-semibold flex items-center gap-2">
                            <i class="fas fa-plus text-primary"></i>
                            Adicionar Conhecimento
                        </h3>
                    </div>
                    <div class="p-6">
                        <form id="knowledgeForm" onsubmit="addKnowledge(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-foreground mb-1">Pergunta / Tópico *</label>
                                    <input type="text" name="question" required
                                           class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary"
                                           placeholder="Ex: Como o Brudam calcula frete?">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-foreground mb-1">Categoria</label>
                                    <select name="category" 
                                            class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                                        <option value="Geral">Geral</option>
                                        <option value="Brudam">Brudam</option>
                                        <option value="Fiscal">Fiscal</option>
                                        <option value="Operacional">Operacional</option>
                                        <option value="Sistema">Sistema</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-foreground mb-1">Resposta / Conteúdo *</label>
                                    <textarea name="answer" rows="6" required
                                              class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary"
                                              placeholder="Explique detalhadamente..."></textarea>
                                </div>
                                <button type="submit" class="w-full rounded-md bg-primary px-4 py-2 text-sm font-medium text-white hover:bg-primary/90 transition-colors">
                                    <i class="fas fa-save mr-2"></i>Salvar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conteúdo da Tab Base de Conhecimento -->
        <div id="content-knowledge" class="tab-content hidden h-[calc(100vh-250px)] min-h-[500px]">
            <div class="grid h-full grid-cols-1 gap-6 lg:grid-cols-3">
                <!-- Lista de Conhecimento -->
                <div class="lg:col-span-2 flex flex-col rounded-lg border bg-card shadow-sm overflow-hidden">
                    <div class="border-b px-6 py-4 flex justify-between items-center">
                        <h3 class="font-semibold flex items-center gap-2">
                            <i class="fas fa-book text-primary"></i>
                            Itens de Conhecimento
                        </h3>
                        <div class="relative">
                            <input type="text" id="knowledge-search" onkeyup="filterKnowledge()" placeholder="Buscar..." 
                                   class="pl-8 pr-3 py-1 text-sm rounded-md border border-input bg-background focus:outline-none focus:ring-1 focus:ring-primary w-48">
                            <i class="fas fa-search absolute left-2.5 top-2 text-xs text-muted-foreground"></i>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 space-y-3" id="knowledge-list">
                        <div class="text-center py-8 text-muted-foreground">Carregando...</div>
                    </div>
                </div>

                <!-- Formulário de Adição -->
                <div class="rounded-lg border bg-card shadow-sm h-fit">
                    <div class="border-b px-6 py-4">
                        <h3 class="font-semibold flex items-center gap-2">
                            <i class="fas fa-plus text-primary"></i>
                            Adicionar Conhecimento
                        </h3>
                    </div>
                    <div class="p-6">
                        <form id="knowledgeForm" onsubmit="addKnowledge(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-foreground mb-1">Pergunta / Tópico *</label>
                                    <input type="text" name="question" required
                                           class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary"
                                           placeholder="Ex: Como o Brudam calcula frete?">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-foreground mb-1">Categoria</label>
                                    <select name="category" 
                                            class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                                        <option value="Geral">Geral</option>
                                        <option value="Brudam">Brudam</option>
                                        <option value="Fiscal">Fiscal</option>
                                        <option value="Operacional">Operacional</option>
                                        <option value="Sistema">Sistema</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-foreground mb-1">Resposta / Conteúdo *</label>
                                    <textarea name="answer" rows="6" required
                                              class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary"
                                              placeholder="Explique detalhadamente..."></textarea>
                                </div>
                                <button type="submit" class="w-full rounded-md bg-primary px-4 py-2 text-sm font-medium text-white hover:bg-primary/90 transition-colors">
                                    <i class="fas fa-save mr-2"></i>Salvar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conteúdo da Tab Dashboard -->
        <div id="content-dashboard" class="tab-content hidden">
            <div class="grid gap-6 lg:grid-cols-3">
                <!-- Formulário de Geração de Dashboard -->
                <div class="lg:col-span-2">
                    <div class="rounded-lg border bg-card shadow-sm">
                        <div class="border-b px-6 py-4">
                            <h3 class="flex items-center gap-2 text-lg font-semibold">
                                <i class="fas fa-chart-bar text-primary"></i>
                                Gerar Novo Dashboard
                            </h3>
                        </div>
                        <div class="p-6">
                            <form id="dashboardGenForm" onsubmit="submitDashboardGen(event)">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-foreground mb-1">
                                            Título do Dashboard *
                                        </label>
                                        <input type="text" name="title" required
                                               class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary"
                                               placeholder="Ex: Análise de Vendas Q4">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-foreground mb-1">
                                            Descrição *
                                        </label>
                                        <textarea name="description" rows="3" required
                                                  class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary"
                                                  placeholder="Descreva o objetivo e os dados que devem ser apresentados..."></textarea>
                                    </div>
                                    
                                    <div class="grid gap-4 md:grid-cols-2">
                                        <div>
                                            <label class="block text-sm font-medium text-foreground mb-1">
                                                Fonte de Dados *
                                            </label>
                                            <select name="data_source" required
                                                    class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                                                <option value="">Selecione...</option>
                                                {% for source in data_sources %}
                                                <option value="{{ source.id }}">{{ source.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-foreground mb-1">
                                                Categoria *
                                            </label>
                                            <select name="category" required
                                                    class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                                                <option value="Comercial">Comercial</option>
                                                <option value="Financeiro">Financeiro</option>
                                                <option value="Operações">Operações</option>
                                                <option value="RH">RH</option>
                                                <option value="Logística">Logística</option>
                                                <option value="Outros">Outros</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-foreground mb-1">
                                            Tipo de Visualização
                                        </label>
                                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-2">
                                            <label class="flex items-center gap-2 rounded-lg border p-3 cursor-pointer hover:bg-muted/50 transition-colors">
                                                <input type="checkbox" name="chart_types" value="bar" class="rounded border-input">
                                                <i class="fas fa-chart-bar text-primary"></i>
                                                <span class="text-sm">Barras</span>
                                            </label>
                                            <label class="flex items-center gap-2 rounded-lg border p-3 cursor-pointer hover:bg-muted/50 transition-colors">
                                                <input type="checkbox" name="chart_types" value="line" class="rounded border-input">
                                                <i class="fas fa-chart-line text-primary"></i>
                                                <span class="text-sm">Linhas</span>
                                            </label>
                                            <label class="flex items-center gap-2 rounded-lg border p-3 cursor-pointer hover:bg-muted/50 transition-colors">
                                                <input type="checkbox" name="chart_types" value="pie" class="rounded border-input">
                                                <i class="fas fa-chart-pie text-primary"></i>
                                                <span class="text-sm">Pizza</span>
                                            </label>
                                            <label class="flex items-center gap-2 rounded-lg border p-3 cursor-pointer hover:bg-muted/50 transition-colors">
                                                <input type="checkbox" name="chart_types" value="table" class="rounded border-input">
                                                <i class="fas fa-table text-primary"></i>
                                                <span class="text-sm">Tabela</span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-foreground mb-1">
                                            Filtros e Parâmetros (JSON)
                                        </label>
                                        <textarea name="filters" rows="3"
                                                  class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-primary"
                                                  placeholder='{"periodo": "2024-Q4", "unidade": "SC"}'></textarea>
                                    </div>
                                </div>
                                
                                <div class="mt-6 flex justify-end gap-3">
                                    <button type="reset" class="rounded-md border border-input bg-background px-4 py-2 text-sm font-medium hover:bg-accent transition-colors">
                                        Limpar
                                    </button>
                                    <button type="submit" class="rounded-md bg-primary px-4 py-2 text-sm font-medium text-white hover:bg-primary/90 transition-colors">
                                        <i class="fas fa-magic mr-2"></i>
                                        Gerar Dashboard
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Sidebar com Informações -->
                <div class="space-y-6">
                    <!-- Status das Gerações -->
                    <div class="rounded-lg border bg-card shadow-sm">
                        <div class="border-b px-6 py-4">
                            <h3 class="flex items-center gap-2 text-lg font-semibold">
                                <i class="fas fa-tasks text-primary"></i>
                                Status
                            </h3>
                        </div>
                        <div class="p-6 space-y-4">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-muted-foreground">Pendentes</span>
                                <span class="rounded-full bg-amber-100 px-2.5 py-0.5 text-xs font-medium text-amber-800">
                                    {{ dashboard_stats.pending }}
                                </span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-muted-foreground">Processando</span>
                                <span class="rounded-full bg-blue-100 px-2.5 py-0.5 text-xs font-medium text-blue-800">
                                    {{ dashboard_stats.processing }}
                                </span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-muted-foreground">Concluídos</span>
                                <span class="rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800">
                                    {{ dashboard_stats.completed }}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fontes de Dados -->
                    <div class="rounded-lg border bg-card shadow-sm">
                        <div class="border-b px-6 py-4">
                            <h3 class="flex items-center gap-2 text-lg font-semibold">
                                <i class="fas fa-database text-primary"></i>
                                Fontes de Dados
                            </h3>
                        </div>
                        <div class="p-4">
                            <ul class="space-y-2">
                                {% for source in data_sources %}
                                <li class="flex items-center gap-2 text-sm">
                                    <i class="fas fa-plug text-green-500"></i>
                                    {{ source.name }}
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Lista de Dashboards Gerados -->
            <div class="mt-8 rounded-lg border bg-card shadow-sm">
                <div class="border-b px-6 py-4">
                    <h3 class="flex items-center gap-2 text-lg font-semibold">
                        <i class="fas fa-history text-primary"></i>
                        Dashboards Gerados
                    </h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-muted/50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-muted-foreground">Título</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-muted-foreground">Categoria</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-muted-foreground">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-muted-foreground">Criado em</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-muted-foreground">Ações</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-border">
                            {% for dash in generated_dashboards %}
                            <tr class="hover:bg-muted/30">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">{{ dash.title }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-muted-foreground">{{ dash.category }}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="rounded-full px-2.5 py-0.5 text-xs font-medium
                                        {% if dash.status == 'pending' %}bg-amber-100 text-amber-800
                                        {% elif dash.status == 'processing' %}bg-blue-100 text-blue-800
                                        {% elif dash.status == 'completed' %}bg-green-100 text-green-800
                                        {% else %}bg-red-100 text-red-800{% endif %}">
                                        {{ dash.status }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-muted-foreground">{{ dash.created_at }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    {% if dash.status == 'completed' and dash.result_data %}
                                    <a href="{{ url_for('export_dashboard_to_excel', dash_id=dash.id) }}" class="text-green-600 hover:underline mr-2" title="Exportar Excel">
                                        <i class="fas fa-file-excel"></i>
                                    </a>
                                    {% endif %}
                                    <a href="{{ url_for('view_dashboard_gen_page', request_id=dash.id) }}" class="text-primary hover:underline mr-2" title="Ver Detalhes">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <button onclick="refreshDashboard({{ dash.id }})" class="text-blue-500 hover:underline mr-2" title="Atualizar Dados">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                    <button onclick="deleteDashboardGen({{ dash.id }})" class="text-destructive hover:underline" title="Excluir">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="px-6 py-8 text-center text-muted-foreground">
                                    <i class="fas fa-inbox text-4xl mb-2"></i>
                                    <p>Nenhum dashboard gerado ainda</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Conteúdo da Tab Meus Dashboards -->
        <div id="content-my-dashboards" class="tab-content hidden">
            <div class="space-y-6">
                <!-- Header com ações -->
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold">Meus Dashboards</h3>
                        <p class="text-sm text-muted-foreground">Dashboards criados e salvos por você</p>
                    </div>
                    <a href="{{ url_for('dashboard_editor_new') }}" 
                       class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-sm font-medium text-white hover:bg-primary/90 transition-colors">
                        <i class="fas fa-plus"></i>
                        Novo Dashboard
                    </a>
                </div>

                <!-- Grid de Dashboards -->
                <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                    {% for template in dashboard_templates %}
                    <div class="rounded-lg border bg-card shadow-sm hover:shadow-md transition-shadow overflow-hidden">
                        <!-- Thumbnail/Preview -->
                        <div class="aspect-video bg-gradient-to-br from-primary/10 to-primary/5 flex items-center justify-center">
                            {% if template.thumbnail_url %}
                            <img src="{{ template.thumbnail_url }}" alt="{{ template.title }}" class="w-full h-full object-cover">
                            {% else %}
                            <i class="fas fa-chart-bar text-4xl text-primary/30"></i>
                            {% endif %}
                        </div>
                        <div class="p-4">
                            <div class="flex items-start justify-between mb-2">
                                <span class="rounded-full bg-primary/10 px-2 py-0.5 text-xs font-medium text-primary">
                                    {{ template.category }}
                                </span>
                                {% if template.is_published %}
                                <span class="rounded-full bg-green-100 px-2 py-0.5 text-xs font-medium text-green-700">
                                    Publicado
                                </span>
                                {% else %}
                                <span class="rounded-full bg-amber-100 px-2 py-0.5 text-xs font-medium text-amber-700">
                                    Rascunho
                                </span>
                                {% endif %}
                            </div>
                            <h4 class="font-semibold mb-1">{{ template.title }}</h4>
                            <p class="text-sm text-muted-foreground line-clamp-2 mb-4">{{ template.description or 'Sem descrição' }}</p>
                            <div class="flex items-center gap-2">
                                <a href="{{ url_for('view_dashboard_template', template_id=template.id) }}" 
                                   class="flex-1 inline-flex items-center justify-center gap-2 rounded-md bg-primary/10 px-3 py-2 text-sm font-medium text-primary hover:bg-primary/20 transition-colors">
                                    <i class="fas fa-eye"></i>
                                    Visualizar
                                </a>
                                <a href="{{ url_for('dashboard_editor', template_id=template.id) }}" 
                                   class="inline-flex items-center justify-center rounded-md border px-3 py-2 text-sm font-medium hover:bg-muted/50 transition-colors">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button onclick="deleteDashboardTemplate({{ template.id }})" 
                                        class="inline-flex items-center justify-center rounded-md border px-3 py-2 text-sm font-medium text-red-600 hover:bg-red-50 transition-colors">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="col-span-full text-center py-12">
                        <div class="rounded-full bg-muted w-16 h-16 flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-chart-pie text-2xl text-muted-foreground"></i>
                        </div>
                        <h4 class="font-semibold mb-2">Nenhum dashboard criado</h4>
                        <p class="text-sm text-muted-foreground mb-4">Crie seu primeiro dashboard personalizado</p>
                        <a href="{{ url_for('dashboard_editor_new') }}" 
                           class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-sm font-medium text-white hover:bg-primary/90 transition-colors">
                            <i class="fas fa-plus"></i>
                            Criar Dashboard
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Conteúdo da Tab Executáveis -->
        <div id="content-executables" class="tab-content hidden">
            <div class="rounded-lg border bg-card shadow-sm">
                <div class="border-b px-6 py-4">
                    <h3 class="flex items-center gap-2 text-lg font-semibold">
                        <i class="fas fa-play-circle text-primary"></i>
                        Tipos de Automação
                    </h3>
                    <p class="text-sm text-muted-foreground mt-1">
                        Selecione um tipo para criar uma nova automação
                    </p>
                </div>
                <div class="p-6">
                    {% if rpa_types %}
                    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                        {% for tipo in rpa_types %}
                        {% if tipo.is_active %}
                        <div class="rounded-lg border bg-card p-6 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex items-start justify-between mb-4">
                                <div class="rounded-lg bg-primary/10 p-3 text-primary">
                                    <i class="fas {{ tipo.icon or 'fa-cog' }} text-xl"></i>
                                </div>
                                {% if tipo.rpa_count and tipo.rpa_count > 0 %}
                                <span class="rounded-full bg-green-100 px-2 py-1 text-xs font-medium text-green-800">
                                    {{ tipo.rpa_count }} RPA(s)
                                </span>
                                {% else %}
                                <span class="rounded-full bg-gray-100 px-2 py-1 text-xs font-medium text-gray-600">
                                    Disponível
                                </span>
                                {% endif %}
                            </div>
                            <h4 class="mb-2 font-semibold">{{ tipo.name }}</h4>
                            <p class="mb-4 text-sm text-muted-foreground">{{ tipo.description or 'Sem descrição' }}</p>
                            <button onclick="initiateRPA({{ tipo.id }}, '{{ tipo.name }}')" 
                                    class="w-full inline-flex items-center justify-center rounded-md bg-primary/10 px-4 py-2 text-sm font-medium text-primary hover:bg-primary/20 transition-colors">
                                <i class="fas fa-plus mr-2"></i>
                                Criar Automação
                            </button>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-12">
                        <i class="fas fa-inbox text-4xl text-muted-foreground mb-4"></i>
                        <p class="text-muted-foreground">Nenhum tipo de automação cadastrado</p>
                        <p class="text-sm text-muted-foreground mt-2">Configure os tipos de RPA no painel administrativo</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Conteúdo da Tab Auditoria Fiscal -->
        <div id="content-auditoria" class="tab-content">
            <div class="space-y-6" style="display: block;">
                <!-- Header com Filtros -->
                <div class="rounded-lg border bg-card shadow-sm">
                    <div class="border-b px-6 py-4">
                        <h3 class="flex items-center gap-2 text-lg font-semibold">
                            <i class="fas fa-filter text-primary"></i>
                            Filtros de Busca
                        </h3>
                    </div>
                    <div class="p-6">
                        <div class="grid gap-4 md:grid-cols-4">
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-1">
                                    Data Início *
                                </label>
                                <input type="date" id="audit-data-inicio"
                                       class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-1">
                                    Data Fim *
                                </label>
                                <input type="date" id="audit-data-fim"
                                       class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-1">
                                    Operador (opcional)
                                </label>
                            <div class="flex items-end">
                                <button onclick="buscarAuditoria()" class="w-full h-full rounded-md bg-primary px-4 py-2 text-sm font-medium text-white hover:bg-primary/90 transition-colors flex items-center justify-center gap-2">
                                    <i class="fas fa-search"></i>
                                    Buscar
                                </button>
                            </div>
                        </div>
                        <div class="mt-3 flex gap-2 flex-wrap">
                            <button onclick="setDateRange('hoje')" class="rounded-md border border-input bg-background px-3 py-1 text-xs font-medium hover:bg-accent transition-colors flex-1 md:flex-none">
                                Hoje
                            </button>
                            <button onclick="setDateRange('semana')" class="rounded-md border border-input bg-background px-3 py-1 text-xs font-medium hover:bg-accent transition-colors flex-1 md:flex-none">
                                Última Semana
                            </button>
                            <button onclick="setDateRange('mes')" class="rounded-md border border-input bg-background px-3 py-1 text-xs font-medium hover:bg-accent transition-colors flex-1 md:flex-none">
                                Último Mês
                            </button>
                            <button onclick="setDateRange('trimestre')" class="rounded-md border border-input bg-background px-3 py-1 text-xs font-medium hover:bg-accent transition-colors flex-1 md:flex-none">
                                Último Trimestre
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="audit-loading" class="hidden text-center py-12">
                    <i class="fas fa-spinner fa-spin text-4xl text-primary mb-4"></i>
                    <p id="audit-loading-text" class="text-muted-foreground">Carregando dados...</p>
                </div>

                <!-- Resultados -->
                <div id="audit-results" class="hidden space-y-6">
                    <!-- Resumo Geral -->
                    <div class="grid gap-4 grid-cols-2 md:grid-cols-4">
                        <div class="rounded-lg border bg-card p-4 shadow-sm">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-muted-foreground">Total de Manifestos</span>
                                <i class="fas fa-file-alt text-primary"></i>
                            </div>
                            <p id="audit-total-manifestos" class="text-2xl font-bold mt-2">0</p>
                        </div>
                        <div class="rounded-lg border bg-card p-4 shadow-sm">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-muted-foreground">Operadores Ativos</span>
                                <i class="fas fa-users text-blue-500"></i>
                            </div>
                            <p id="audit-total-operadores" class="text-2xl font-bold mt-2">0</p>
                        </div>
                        <div class="rounded-lg border bg-card p-4 shadow-sm">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-muted-foreground">Valor Total NF</span>
                                <i class="fas fa-dollar-sign text-green-500"></i>
                            </div>
                            <p id="audit-valor-total" class="text-2xl font-bold mt-2">R$ 0</p>
                        </div>
                        <div class="rounded-lg border bg-card p-4 shadow-sm">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-muted-foreground">KM Total Rodado</span>
                                <i class="fas fa-road text-amber-500"></i>
                            </div>
                            <p id="audit-km-total" class="text-2xl font-bold mt-2">0 km</p>
                        </div>
                    </div>

                    <!-- Resumo por Operador -->
                    <div class="rounded-lg border bg-card shadow-sm">
                        <div class="border-b px-6 py-4 flex items-center justify-between">
                            <h3 class="flex items-center gap-2 text-lg font-semibold">
                                <i class="fas fa-user-tie text-primary"></i>
                                Manifestos por Operador
                            </h3>
                            <span class="text-sm text-muted-foreground">
                                Clique em um operador para ver detalhes
                            </span>
                        </div>
                        <div id="audit-operadores-list" class="divide-y divide-border">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Tabela de Manifestos (expandida ao clicar no operador) -->
                    <div id="audit-manifestos-detail" class="hidden rounded-lg border bg-card shadow-sm">
                        <div class="border-b px-6 py-4 flex items-center justify-between">
                            <h3 class="flex items-center gap-2 text-lg font-semibold">
                                <i class="fas fa-list text-primary"></i>
                                <span id="audit-detail-title">Manifestos</span>
                            </h3>
                            <div class="flex items-center gap-2">
                                <button onclick="exportarExcel()" class="text-green-600 hover:text-green-700 mr-2" title="Baixar Excel">
                                    <i class="fas fa-file-excel text-xl"></i>
                                </button>
                                <button onclick="hideManifestosDetail()" class="text-muted-foreground hover:text-foreground">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-muted/50">
                                    <tr>
                                        <th onclick="ordenarPor('id_manifesto')" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-muted-foreground cursor-pointer hover:bg-muted transition-colors group">
                                            ID <i class="fas fa-sort ml-1 text-muted-foreground/30 group-hover:text-muted-foreground"></i>
                                        </th>
                                        <th onclick="ordenarPor('data_emissao')" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-muted-foreground cursor-pointer hover:bg-muted transition-colors group">
                                            Data <i class="fas fa-sort ml-1 text-muted-foreground/30 group-hover:text-muted-foreground"></i>
                                        </th>
                                        <th onclick="ordenarPor('tipo_descricao')" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-muted-foreground cursor-pointer hover:bg-muted transition-colors group hidden md:table-cell">
                                            Tipo <i class="fas fa-sort ml-1 text-muted-foreground/30 group-hover:text-muted-foreground"></i>
                                        </th>
                                        <th onclick="ordenarPor('agente_nome')" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-muted-foreground cursor-pointer hover:bg-muted transition-colors group hidden md:table-cell">
                                            Agente <i class="fas fa-sort ml-1 text-muted-foreground/30 group-hover:text-muted-foreground"></i>
                                        </th>
                                        <th onclick="ordenarPor('motorista_nome')" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-muted-foreground cursor-pointer hover:bg-muted transition-colors group">
                                            Motorista <i class="fas fa-sort ml-1 text-muted-foreground/30 group-hover:text-muted-foreground"></i>
                                        </th>
                                        <th onclick="ordenarPor('veiculo_placa')" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-muted-foreground cursor-pointer hover:bg-muted transition-colors group hidden md:table-cell">
                                            Veículo <i class="fas fa-sort ml-1 text-muted-foreground/30 group-hover:text-muted-foreground"></i>
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-muted-foreground hidden md:table-cell">KM Inicial</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-muted-foreground hidden md:table-cell">KM Final</th>
                                        <th onclick="ordenarPor('km_rodado')" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-muted-foreground cursor-pointer hover:bg-muted transition-colors group hidden md:table-cell">
                                            KM Rodado <i class="fas fa-sort ml-1 text-muted-foreground/30 group-hover:text-muted-foreground"></i>
                                        </th>
                                        <th onclick="ordenarPor('total_nf_valor')" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-muted-foreground cursor-pointer hover:bg-muted transition-colors group">
                                            Valor NF <i class="fas fa-sort ml-1 text-muted-foreground/30 group-hover:text-muted-foreground"></i>
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-muted-foreground">Custo Total</th>
                                    </tr>
                                </thead>
                                <tbody id="audit-manifestos-tbody" class="divide-y divide-border">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Estado Vazio -->
                <div id="audit-empty" class="text-center py-12">
                    <div class="rounded-full bg-muted w-16 h-16 flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-search-dollar text-2xl text-muted-foreground"></i>
                    </div>
                    <h4 class="font-semibold mb-2">Auditoria de Manifestos</h4>
                    <p class="text-sm text-muted-foreground mb-4">
                        Selecione um período e clique em "Buscar" para visualizar os manifestos emitidos.
                    </p>
                </div>

                <!-- Estado de Erro de Conexão -->
                <div id="audit-connection-error" class="hidden text-center py-12">
                    <div class="rounded-full bg-red-100 w-16 h-16 flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-plug text-2xl text-red-500"></i>
                    </div>
                    <h4 class="font-semibold mb-2 text-red-700">Erro de Conexão</h4>
                    <p id="audit-error-message" class="text-sm text-muted-foreground mb-4">
                        Não foi possível conectar ao banco de dados.
                    </p>
                    <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 max-w-md mx-auto text-left">
                        <h5 class="font-medium text-amber-800 mb-2">
                            <i class="fas fa-exclamation-triangle mr-2"></i>Verifique:
                        </h5>
                        <ul class="text-sm text-amber-700 space-y-1">
                            <li>• ZeroTier está conectado?</li>
                            <li>• IP 10.147.17.88 está acessível?</li>
                            <li>• Credenciais MySQL estão corretas?</li>
                            <li>• O servidor MySQL está online?</li>
                        </ul>
                    </div>
                    <button onclick="buscarAuditoria()" class="mt-4 rounded-md bg-primary px-4 py-2 text-sm font-medium text-white hover:bg-primary/90">
                        <i class="fas fa-redo mr-2"></i>Tentar Novamente
                    </button>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
// Variáveis globais para auditoria
let auditManifestos = [];
let auditStatsOperadores = [];
let currentSort = { field: 'data_emissao', direction: 'desc' };
let currentManifestos = [];

function switchTab(tabName) {
    // Esconde todos os conteúdos
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    
    // Reseta cor de borda e texto
    document.querySelectorAll('.tab-button').forEach(el => {
        el.classList.remove('border-primary', 'text-primary');
        el.classList.add('border-transparent', 'text-muted-foreground');
    });
    
    // Mostra conteúdo selecionado
    document.getElementById(`content-${tabName}`).classList.remove('hidden');
    
    // Ativa aba selecionada
    const activeTab = document.getElementById(`tab-${tabName}`);
    activeTab.classList.remove('border-transparent', 'text-muted-foreground');
    activeTab.classList.add('border-primary', 'text-primary');
}

function initiateRPA(typeId, typeName) {
    switchTab('rpa');
    const select = document.querySelector('select[name="rpa_type"]');
    if (select) {
        select.value = typeId;
        // Scroll para o formulário
        document.getElementById('rpaForm').scrollIntoView({ behavior: 'smooth' });
        // Focar no nome
        document.querySelector('input[name="name"]').focus();
    }
}

async function submitRPA(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    
    try {
        const response = await fetch('/api/agent/rpa', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(Object.fromEntries(formData))
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert('Automação criada com sucesso!');
            window.location.reload();
        } else {
            alert('Erro: ' + (data.error || 'Erro desconhecido'));
        }
    } catch (error) {
        alert('Erro ao criar automação: ' + error.message);
    }
}

async function submitDashboardGen(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    
    // Pega os tipos de gráfico selecionados
    const chartTypes = [];
    form.querySelectorAll('input[name="chart_types"]:checked').forEach(cb => {
        chartTypes.push(cb.value);
    });
    
    const data = Object.fromEntries(formData);
    data.chart_types = chartTypes;
    
    try {
        const response = await fetch('/api/agent/dashboard-gen', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert('Solicitação de dashboard enviada com sucesso!');
            window.location.reload();
        } else {
            alert('Erro: ' + (result.error || 'Erro desconhecido'));
        }
    } catch (error) {
        alert('Erro ao gerar dashboard: ' + error.message);
    }
}

function viewRPA(id) {
    window.location.href = '/agent/rpa/' + id;
}

async function executeRPA(id) {
    if (!confirm('Deseja executar esta automação agora?')) return;
    
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/agent/rpa/' + id + '/execute', { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        
        if (data.success) {
            alert('Automação executada com sucesso!\n\nRegistros: ' + (data.row_count || 0));
            window.location.reload();
        } else {
            alert('Erro na execução: ' + (data.error || 'Erro desconhecido'));
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        }
    } catch (error) {
        alert('Erro ao executar: ' + error.message);
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    }
}

async function viewRPALogs(id) {
    try {
        const response = await fetch('/api/agent/rpa/' + id + '/logs');
        const data = await response.json();
        
        if (data.error) {
            alert('Erro: ' + data.error);
            return;
        }
        
        // Criar modal de logs
        let logsHtml = '<div class="space-y-4">';
        
        // Status atual
        logsHtml += '<div class="p-4 rounded-lg bg-muted">';
        logsHtml += '<h4 class="font-semibold mb-2">Status Atual</h4>';
        logsHtml += '<p><strong>Status:</strong> ' + (data.status.status || 'N/A') + '</p>';
        if (data.status.executed_at) {
            logsHtml += '<p><strong>Executado em:</strong> ' + data.status.executed_at + '</p>';
        }
        if (data.status.completed_at) {
            logsHtml += '<p><strong>Concluído em:</strong> ' + data.status.completed_at + '</p>';
        }
        if (data.status.error_message) {
            logsHtml += '<p class="text-red-600"><strong>Erro:</strong> ' + data.status.error_message + '</p>';
        }
        logsHtml += '</div>';
        
        // Resultado
        if (data.status.result) {
            logsHtml += '<div class="p-4 rounded-lg bg-green-50 border border-green-200">';
            logsHtml += '<h4 class="font-semibold mb-2 text-green-800">Resultado</h4>';
            logsHtml += '<pre class="text-xs overflow-auto max-h-40">' + JSON.stringify(data.status.result, null, 2) + '</pre>';
            logsHtml += '</div>';
        }
        
        // Logs de execução
        if (data.logs && data.logs.length > 0) {
            logsHtml += '<div class="p-4 rounded-lg bg-gray-50 border">';
            logsHtml += '<h4 class="font-semibold mb-2">Histórico de Execuções</h4>';
            logsHtml += '<div class="space-y-2 max-h-60 overflow-auto">';
            data.logs.forEach(log => {
                const details = log.details || {};
                const logLines = details.logs || [];
                logsHtml += '<div class="text-xs border-b pb-2">';
                logsHtml += '<p class="text-muted-foreground">' + log.created_at + ' - ' + log.action_type + '</p>';
                if (logLines.length > 0) {
                    logsHtml += '<pre class="mt-1 text-xs bg-black text-green-400 p-2 rounded overflow-auto max-h-32">';
                    logLines.forEach(line => {
                        logsHtml += line + '\n';
                    });
                    logsHtml += '</pre>';
                }
                logsHtml += '</div>';
            });
            logsHtml += '</div></div>';
        }
        
        logsHtml += '</div>';
        
        // Mostrar modal
        showModal('Logs da Automação', logsHtml);
        
    } catch (error) {
        alert('Erro ao buscar logs: ' + error.message);
    }
}

function showModal(title, content) {
    // Remove modal existente se houver
    const existingModal = document.getElementById('rpaLogsModal');
    if (existingModal) existingModal.remove();
    
    const modal = document.createElement('div');
    modal.id = 'rpaLogsModal';
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/50';
    modal.innerHTML = `
        <div class="bg-card rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden">
            <div class="flex items-center justify-between border-b px-6 py-4">
                <h3 class="text-lg font-semibold">${title}</h3>
                <button onclick="document.getElementById('rpaLogsModal').remove()" class="text-muted-foreground hover:text-foreground">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 overflow-auto max-h-[60vh]">
                ${content}
            </div>
            <div class="border-t px-6 py-4 flex justify-end">
                <button onclick="document.getElementById('rpaLogsModal').remove()" class="rounded-md bg-primary px-4 py-2 text-sm font-medium text-white hover:bg-primary/90">
                    Fechar
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Fechar ao clicar fora
    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
    });
}

function deleteRPA(id) {
    if (confirm('Tem certeza que deseja excluir esta automação?')) {
        fetch('/api/agent/rpa/' + id, { method: 'DELETE' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Erro ao excluir: ' + data.error);
                }
            });
    }
}

function viewDashboardGen(id) {
    window.location.href = '/agent/dashboard-gen/' + id;
}

function deleteDashboardGen(id) {
    if (confirm('Tem certeza que deseja excluir esta solicitação?')) {
        fetch('/api/agent/dashboard-gen/' + id, { method: 'DELETE' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Erro ao excluir: ' + data.error);
                }
            });
    }
}

async function refreshDashboard(id) {
    try {
        const response = await fetch('/api/agent/dashboard-gen/' + id + '/refresh', { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        
        if (data.success) {
            alert('Dashboard recolocado na fila! O agente irá processá-lo em breve.');
            window.location.reload();
        } else {
            alert('Erro: ' + (data.error || 'Erro desconhecido'));
        }
    } catch (error) {
        alert('Erro ao atualizar: ' + error.message);
    }
}

function deleteDashboardTemplate(id) {
    if (confirm('Tem certeza que deseja excluir este dashboard?')) {
        fetch('/api/agent/dashboard-template/' + id, { method: 'DELETE' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Erro ao excluir: ' + data.error);
                }
            });
    }
}

// ============================================================
// FUNÇÕES DE CHAT IA
// ============================================================

let currentConversationId = null;

// Inicialização do Chat
document.addEventListener('DOMContentLoaded', function() {
    if(document.getElementById('content-chat')) {
        loadChatHistory();
    }
});

async function loadChatHistory() {
    try {
        const response = await fetch('/api/agent/chat/history');
        const data = await response.json();
        
        const container = document.getElementById('chat-history-list');
        container.innerHTML = '';
        
        if (data.conversations && data.conversations.length > 0) {
            data.conversations.forEach(chat => {
                const isActive = chat.id === currentConversationId ? 'bg-muted' : 'hover:bg-muted/50';
                const date = new Date(chat.updated_at).toLocaleDateString('pt-BR');
                
                const html = `
                    <button onclick="loadConversation(${chat.id})" 
                            class="w-full text-left p-3 rounded-md text-sm transition-colors ${isActive} group relative">
                        <div class="flex justify-between items-start">
                            <span class="font-medium truncate pr-6">${chat.title || 'Nova Conversa'}</span>
                            <span class="text-xs text-muted-foreground whitespace-nowrap">${date}</span>
                        </div>
                        <p class="text-xs text-muted-foreground truncate mt-1">
                            ${chat.last_message || 'Sem mensagens'}
                        </p>
                        <div class="absolute right-2 top-3 hidden group-hover:block">
                            <span onclick="deleteConversation(event, ${chat.id})" class="text-muted-foreground hover:text-destructive p-1">
                                <i class="fas fa-trash-alt"></i>
                            </span>
                        </div>
                    </button>
                `;
                container.innerHTML += html;
            });
        } else {
            container.innerHTML = '<div class="text-center py-4 text-muted-foreground text-sm">Nenhum histórico encontrado</div>';
        }
    } catch (error) {
        console.error('Erro ao carregar histórico:', error);
    }
}

async function loadConversation(id) {
    currentConversationId = id;
    loadChatHistory(); // Atualiza UI da sidebar para marcar ativo
    
    // Limpar mensagens atuais e mostrar loading
    const container = document.getElementById('chat-messages');
    container.innerHTML = `
        <div class="flex justify-center py-8">
            <i class="fas fa-spinner fa-spin text-2xl text-primary"></i>
        </div>
    `;
    
    try {
        const response = await fetch(`/api/agent/chat/${id}/messages`);
        const data = await response.json();
        
        container.innerHTML = '';
        document.getElementById('current-chat-title').textContent = data.title || 'Conversa';
        
        if (data.messages && data.messages.length > 0) {
            data.messages.forEach(msg => appendMessage(msg.role, msg.content, false));
        } else {
            // Mensagem inicial padrão
            appendMessage('assistant', 'Olá! Como posso ajudar você hoje?', false);
        }
        
        scrollToBottom();
    } catch (error) {
        container.innerHTML = '<div class="text-center text-red-500 py-4">Erro ao carregar conversa</div>';
    }
}

async function startNewChat() {
    currentConversationId = null;
    document.getElementById('current-chat-title').textContent = 'Novo Chat';
    document.getElementById('chat-messages').innerHTML = '';
    appendMessage('assistant', 'Olá! Iniciei uma nova conversa. Como posso ajudar?', false);
    loadChatHistory(); // Atualiza seleção
}

async function deleteConversation(event, id) {
    event.stopPropagation(); // Evita abrir o chat ao clicar no delete
    if (!confirm('Tem certeza que deseja apagar esta conversa?')) return;
    
    try {
        await fetch(`/api/agent/chat/${id}`, { method: 'DELETE' });
        if (currentConversationId === id) startNewChat();
        loadChatHistory();
    } catch (error) {
        alert('Erro ao apagar conversa');
    }
}

function handleChatKeydown(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('chatForm').dispatchEvent(new Event('submit'));
    }
}

async function sendMessage(e) {
    e.preventDefault();
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    const btn = document.getElementById('send-btn');
    
    if (!message) return;
    
    // UI Updates
    input.value = '';
    input.style.height = 'auto'; // Reset height
    appendMessage('user', message);
    scrollToBottom();
    
    // Disable input while loading
    input.disabled = true;
    btn.disabled = true;
    
    // Mostrar typing indicator
    const typingId = 'typing-' + Date.now();
    appendTypingIndicator(typingId);
    scrollToBottom();
    
    try {
        const response = await fetch('/api/agent/chat/message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                conversation_id: currentConversationId,
                message: message
            })
        });
        
        const data = await response.json();
        
        // Remove typing indicator
        document.getElementById(typingId).remove();
        
        if (data.error) {
            appendMessage('system', 'Erro: ' + data.error);
        } else {
            if (data.conversation_id) {
                currentConversationId = data.conversation_id;
                loadChatHistory(); // Atualiza título se for novo chat
            }
            appendMessage('assistant', data.response);
        }
        
    } catch (error) {
        document.getElementById(typingId)?.remove();
        appendMessage('system', 'Erro de conexão. Tente novamente.');
    } finally {
        input.disabled = false;
        btn.disabled = false;
        input.focus();
        scrollToBottom();
    }
}

function appendMessage(role, content, animate = true) {
    const container = document.getElementById('chat-messages');
    const isUser = role === 'user';
    const isSystem = role === 'system';
    
    let html = '';
    
    if (isSystem) {
        html = `
            <div class="flex justify-center my-4">
                <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full">${content}</span>
            </div>
        `;
    } else {
        // Actions for AI messages
        let actionsHtml = '';
        if (!isUser) {
            // Encode content for safe passing
            const encoded = btoa(unescape(encodeURIComponent(content)));
            actionsHtml = `
                <div class="mt-2 flex gap-3 border-t border-white/10 pt-2">
                    <button onclick="addToKnowledgeFromChat('${encoded}')" class="text-xs opacity-70 hover:opacity-100 flex items-center gap-1 transition-opacity" title="Salvar na Base de Conhecimento">
                        <i class="fas fa-book-medical"></i> Salvar
                    </button>
                    <button onclick="copyChatText(this, '${encoded}')" class="text-xs opacity-70 hover:opacity-100 flex items-center gap-1 transition-opacity" title="Copiar texto">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            `;
        }

        html = `
            <div class="flex items-start gap-3 ${isUser ? 'flex-row-reverse' : ''} ${animate ? 'animate-in fade-in slide-in-from-bottom-2 duration-300' : ''}">
                <div class="w-8 h-8 rounded-full ${isUser ? 'bg-primary text-white' : 'bg-primary/10 text-primary'} flex items-center justify-center flex-shrink-0">
                    <i class="fas ${isUser ? 'fa-user' : 'fa-robot'} text-sm"></i>
                </div>
                <div class="rounded-lg p-3 text-sm max-w-[85%] ${isUser ? 'bg-primary text-white' : 'bg-muted text-foreground'} shadow-sm">
                    <div class="prose prose-sm ${isUser ? 'text-white' : 'dark:prose-invert'} max-w-none">
                        ${formatMessageContent(content)}
                    </div>
                    ${actionsHtml}
                </div>
            </div>
        `;
    }
    
    container.insertAdjacentHTML('beforeend', html);
}

function addToKnowledgeFromChat(encodedContent) {
    try {
        const content = decodeURIComponent(escape(window.atob(encodedContent)));
        switchTab('knowledge');
        
        // Pre-fill form
        const form = document.getElementById('knowledgeForm');
        if (form) {
            const answerField = form.querySelector('textarea[name="answer"]');
            const questionField = form.querySelector('input[name="question"]');
            
            if (answerField) answerField.value = content;
            if (questionField) {
                questionField.value = "Sobre: " + content.substring(0, 30) + "...";
                questionField.focus();
                questionField.select();
            }
            
            // Highlight form
            form.classList.add('ring-2', 'ring-primary');
            setTimeout(() => form.classList.remove('ring-2', 'ring-primary'), 2000);
        }
    } catch (e) {
        console.error("Erro ao decodificar mensagem:", e);
    }
}

function copyChatText(btn, encodedContent) {
    try {
        const content = decodeURIComponent(escape(window.atob(encodedContent)));
        navigator.clipboard.writeText(content).then(() => {
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => btn.innerHTML = original, 1500);
        });
    } catch (e) {
        console.error("Erro ao copiar:", e);
    }
}

function appendTypingIndicator(id) {
    const container = document.getElementById('chat-messages');
    const html = `
        <div id="${id}" class="flex items-start gap-3">
            <div class="w-8 h-8 rounded-full bg-primary/10 text-primary flex items-center justify-center flex-shrink-0">
                <i class="fas fa-robot text-sm"></i>
            </div>
            <div class="rounded-lg bg-muted p-4 text-sm text-foreground">
                <div class="flex gap-1">
                    <div class="w-2 h-2 bg-primary/40 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-primary/40 rounded-full animate-bounce delay-100"></div>
                    <div class="w-2 h-2 bg-primary/40 rounded-full animate-bounce delay-200"></div>
                </div>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
}

function formatMessageContent(text) {
    // Usando marked.js para renderizar Markdown completo (tabelas, listas, negrito, etc)
    try {
        if (typeof marked !== 'undefined') {
            return marked.parse(text);
        }
    } catch (e) {
        console.error('Erro ao renderizar markdown:', e);
    }

    // Fallback manual caso marked não carregue
    let safe = text.replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
        
    // Code blocks
    safe = safe.replace(/```([\s\S]*?)```/g, '<pre class="bg-black/80 text-white p-2 rounded my-2 overflow-x-auto"><code>$1</code></pre>');
    
    // Inline code
    safe = safe.replace(/`([^`]+)`/g, '<code class="bg-black/10 px-1 rounded font-mono text-xs">$1</code>');
    
    // Bold
    safe = safe.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    
    // Italic
    safe = safe.replace(/\*([^*]+)\*/g, '<em>$1</em>');
    
    // Images (Markdown style: ![alt](url))
    safe = safe.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<div class="my-2"><img src="$2" alt="$1" class="max-w-full h-auto rounded-lg shadow-md border" loading="lazy"></div>');
    
    return safe;
}

function scrollToBottom() {
    const container = document.getElementById('chat-messages');
    container.scrollTop = container.scrollHeight;
}

// Auto-resize textarea
document.getElementById('chat-input')?.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
});

// ============================================================
// FUNÇÕES DA BASE DE CONHECIMENTO
// ============================================================

let allKnowledgeItems = [];

async function loadKnowledge() {
    try {
        const response = await fetch('/api/agent/knowledge');
        const data = await response.json();
        
        if (data.items) {
            allKnowledgeItems = data.items;
            renderKnowledgeList(allKnowledgeItems);
        }
    } catch (error) {
        console.error('Erro ao carregar conhecimento:', error);
        document.getElementById('knowledge-list').innerHTML = '<div class="text-center text-red-500">Erro ao carregar dados.</div>';
    }
}

function renderKnowledgeList(items) {
    const container = document.getElementById('knowledge-list');
    container.innerHTML = '';
    
    if (items.length === 0) {
        container.innerHTML = '<div class="text-center py-8 text-muted-foreground">Nenhum item encontrado.</div>';
        return;
    }
    
    items.forEach(item => {
        const html = `
            <div class="p-4 rounded-lg border bg-card hover:bg-accent/5 transition-colors group">
                <div class="flex justify-between items-start mb-2">
                    <span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent bg-primary text-primary-foreground hover:bg-primary/80">
                        ${item.category || 'Geral'}
                    </span>
                    <button onclick="deleteKnowledge(${item.id})" class="text-muted-foreground hover:text-destructive opacity-0 group-hover:opacity-100 transition-opacity" title="Excluir">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                <h4 class="font-semibold mb-1">${item.question}</h4>
                <p class="text-sm text-muted-foreground whitespace-pre-wrap line-clamp-3">${item.answer}</p>
            </div>
        `;
        container.innerHTML += html;
    });
}

function filterKnowledge() {
    const term = document.getElementById('knowledge-search').value.toLowerCase();
    const filtered = allKnowledgeItems.filter(item => 
        item.question.toLowerCase().includes(term) || 
        item.answer.toLowerCase().includes(term) ||
        (item.category && item.category.toLowerCase().includes(term))
    );
    renderKnowledgeList(filtered);
}

async function addKnowledge(event) {
    event.preventDefault();
    const form = event.target;
    const btn = form.querySelector('button[type="submit"]');
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Salvando...';
    
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    try {
        const response = await fetch('/api/agent/knowledge', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            form.reset();
            loadKnowledge();
            // Mostrar feedback visual simples
            const btnClass = btn.className;
            btn.className = "w-full rounded-md bg-green-600 px-4 py-2 text-sm font-medium text-white transition-colors";
            btn.innerHTML = '<i class="fas fa-check mr-2"></i>Salvo!';
            setTimeout(() => {
                btn.className = btnClass;
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 2000);
        } else {
            alert('Erro ao salvar: ' + result.error);
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    } catch (error) {
        alert('Erro ao salvar: ' + error.message);
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

async function deleteKnowledge(id) {
    if (!confirm('Tem certeza que deseja remover este item?')) return;
    
    try {
        const response = await fetch(`/api/agent/knowledge/${id}`, { method: 'DELETE' });
        if (response.ok) {
            loadKnowledge();
        } else {
            alert('Erro ao excluir item.');
        }
    } catch (error) {
        console.error('Erro:', error);
    }
}

// Hook into switchTab to load knowledge when tab is opened
const originalSwitchTab = window.switchTab;
window.switchTab = function(tabName) {
    originalSwitchTab(tabName);
    if (tabName === 'knowledge') {
        loadKnowledge();
    }
};

// ============================================================
// FUNÇÕES DE AUDITORIA FISCAL
// ============================================================

// Inicializar quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
    carregarOperadores();
    // Define datas padrão (último mês)
    setDateRange('mes');
});

function setDateRange(range) {
    const hoje = new Date();
    let dataInicio = new Date();
    let dataFim = new Date();
    
    switch(range) {
        case 'hoje':
            dataInicio = hoje;
            dataFim = hoje;
            break;
        case 'semana':
            dataInicio.setDate(hoje.getDate() - 7);
            break;
        case 'mes':
            dataInicio.setMonth(hoje.getMonth() - 1);
            break;
        case 'trimestre':
            dataInicio.setMonth(hoje.getMonth() - 3);
            break;
    }
    
    document.getElementById('audit-data-inicio').value = formatDateInput(dataInicio);
    document.getElementById('audit-data-fim').value = formatDateInput(dataFim);
}

function formatDateInput(date) {
    return date.toISOString().split('T')[0];
}

function formatDateBR(dateStr) {
    if (!dateStr) return '-';
    const parts = dateStr.split('-');
    if (parts.length === 3) {
        return `${parts[2]}/${parts[1]}/${parts[0]}`;
    }
    return dateStr;
}

function formatCurrency(value) {
    if (value === null || value === undefined) return 'R$ 0,00';
    return new Intl.NumberFormat('pt-BR', { 
        style: 'currency', 
        currency: 'BRL' 
    }).format(value);
}

function formatNumber(value) {
    if (value === null || value === undefined) return '0';
    return new Intl.NumberFormat('pt-BR').format(value);
}

async function carregarOperadores() {
    // Nesta versão assíncrona, a lista de operadores dinâmica depende do agente local.
    // Para simplificar, vamos permitir que o usuário digite o ID ou buscaríamos de um cache.
    // Por enquanto, deixamos vazio ou com uma mensagem.
    try {
        const response = await fetch('/api/agent/auditoria-fiscal/operadores');
        const data = await response.json();
        
        if (data.success && data.operadores && data.operadores.length > 0) {
            const select = document.getElementById('audit-operador');
            data.operadores.forEach(op => {
                const option = document.createElement('option');
                option.value = op.id_usuarios;
                option.textContent = op.primeiro_nome;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.warn('Operadores offline (esperado se servidor não tem acesso ao DB)');
    }
}

let pollingInterval = null;

async function buscarAuditoria() {
    const dataInicio = document.getElementById('audit-data-inicio').value;
    const dataFim = document.getElementById('audit-data-fim').value;
    
    if (!dataInicio || !dataFim) {
        alert('Por favor, selecione as datas de início e fim.');
        return;
    }
    
    // UI: Mostrar loading
    document.getElementById('audit-loading').classList.remove('hidden');
    document.getElementById('audit-loading-text').textContent = 'Solicitando dados ao Agente Local...';
    document.getElementById('audit-results').classList.add('hidden');
    document.getElementById('audit-empty').classList.add('hidden');
    document.getElementById('audit-connection-error').classList.add('hidden');
    document.getElementById('audit-manifestos-detail').classList.add('hidden');
    
    try {
        // 1. Criar solicitação
        const response = await fetch('/api/agent/auditoria-fiscal/request', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                data_inicio: dataInicio,
                data_fim: dataFim
            })
        });
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Erro ao criar solicitação');
        }
        
        const requestId = data.request_id;
        document.getElementById('audit-loading-text').textContent = 'Aguardando processamento do Agente Local...';
        
        // 2. Polling para verificar status
        if (pollingInterval) clearInterval(pollingInterval);
        
        let attempts = 0;
        pollingInterval = setInterval(async () => {
            attempts++;
            if (attempts > 60) { // Timeout de 2 minutos (60 * 2s)
                clearInterval(pollingInterval);
                mostrarErro('Tempo limite excedido. Verifique se o Agente Local está rodando no seu PC.');
                return;
            }
            
            try {
                const statusResp = await fetch(`/api/agent/auditoria-fiscal/status/${requestId}`);
                const statusData = await statusResp.json();
                
                if (statusData.status === 'completed') {
                    clearInterval(pollingInterval);
                    processarResultados(statusData);
                } else if (statusData.status === 'failed') {
                    clearInterval(pollingInterval);
                    mostrarErro('Falha na execução: ' + statusData.error);
                }
                // Se pending ou processing, continua esperando
                
            } catch (e) {
                console.error('Erro no polling:', e);
            }
        }, 2000); // Checa a cada 2 segundos
        
    } catch (error) {
        mostrarErro(error.message);
    }
}

function mostrarErro(msg) {
    document.getElementById('audit-loading').classList.add('hidden');
    document.getElementById('audit-error-message').textContent = msg;
    document.getElementById('audit-connection-error').classList.remove('hidden');
}

function processarResultados(data) {
    document.getElementById('audit-loading').classList.add('hidden');
    
    auditManifestos = data.manifestos || [];
    
    if (auditManifestos.length === 0) {
        document.getElementById('audit-empty').classList.remove('hidden');
        return;
    }
    
    // Calcular estatísticas no frontend
    auditStatsOperadores = calcularEstatisticas(auditManifestos);
    
    // Atualizar resumo
    const totalManifestos = auditManifestos.length;
    const totalOperadores = auditStatsOperadores.length;
    const valorTotal = auditManifestos.reduce((acc, m) => acc + (m.total_nf_valor || 0), 0);
    const kmTotal = auditManifestos.reduce((acc, m) => acc + (m.km_rodado || 0), 0);
    
    document.getElementById('audit-total-manifestos').textContent = formatNumber(totalManifestos);
    document.getElementById('audit-total-operadores').textContent = formatNumber(totalOperadores);
    document.getElementById('audit-valor-total').textContent = formatCurrency(valorTotal);
    document.getElementById('audit-km-total').textContent = formatNumber(kmTotal) + ' km';
    
    renderizarOperadores();
    document.getElementById('audit-results').classList.remove('hidden');
}

function calcularEstatisticas(manifestos) {
    const stats = {};
    
    manifestos.forEach(m => {
        // Usa m.operador (do banco) ou 'unknown'
        const opId = m.operador || 'unknown';
        if (!stats[opId]) {
            stats[opId] = {
                operador_id: opId,
                operador_nome: m.operador_nome || 'Sistema/Desconhecido',
                total_manifestos: 0,
                valor_total: 0,
                km_total: 0,
                primeira_emissao: m.data_emissao,
                ultima_emissao: m.data_emissao
            };
        }
        
        stats[opId].total_manifestos++;
        stats[opId].valor_total += (m.total_nf_valor || 0);
        stats[opId].km_total += (m.km_rodado || 0);
        
        if (m.data_emissao < stats[opId].primeira_emissao) stats[opId].primeira_emissao = m.data_emissao;
        if (m.data_emissao > stats[opId].ultima_emissao) stats[opId].ultima_emissao = m.data_emissao;
    });
    
    return Object.values(stats).sort((a, b) => b.total_manifestos - a.total_manifestos);
}


function renderizarOperadores() {
    const container = document.getElementById('audit-operadores-list');
    container.innerHTML = '';
    
    auditStatsOperadores.forEach((op, index) => {
        const percent = auditManifestos.length > 0 
            ? Math.round((op.total_manifestos / auditManifestos.length) * 100) 
            : 0;
        
        // Aspas no ID para evitar erro se for string 'unknown'
        const html = `
            <div class="p-4 hover:bg-muted/30 cursor-pointer transition-colors" onclick="mostrarManifestosOperador('${op.operador_id}', '${op.operador_nome}')">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
                            <i class="fas fa-user text-primary"></i>
                        </div>
                        <div>
                            <p class="font-semibold">${op.operador_nome}</p>
                            <p class="text-xs text-muted-foreground">
                                ${formatDateBR(op.primeira_emissao)} - ${formatDateBR(op.ultima_emissao)}
                            </p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-bold text-primary">${op.total_manifestos}</p>
                        <p class="text-xs text-muted-foreground">manifestos</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 text-sm mt-3">
                    <div>
                        <p class="text-muted-foreground">Valor NF</p>
                        <p class="font-medium">${formatCurrency(op.valor_total)}</p>
                    </div>
                    <div>
                        <p class="text-muted-foreground">% do Total</p>
                        <p class="font-medium">${percent}%</p>
                    </div>
                </div>
                <div class="mt-3 h-2 bg-muted rounded-full overflow-hidden">
                    <div class="h-full bg-primary rounded-full transition-all" style="width: ${percent}%"></div>
                </div>
            </div>
        `;
        container.innerHTML += html;
    });
}

function mostrarManifestosOperador(operadorId, operadorNome) {
    // Filtra comparando string para garantir
    currentManifestos = auditManifestos.filter(m => (m.operador || 'unknown') == operadorId);
    
    // Atualiza título e reseta ordenação
    document.getElementById('audit-detail-title').textContent = 
        `Manifestos de ${operadorNome} (${currentManifestos.length})`;
    
    // Renderiza
    renderizarTabelaManifestos();
    
    document.getElementById('audit-manifestos-detail').classList.remove('hidden');
    document.getElementById('audit-manifestos-detail').scrollIntoView({ behavior: 'smooth' });
}

function ordenarPor(field) {
    if (currentSort.field === field) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.field = field;
        currentSort.direction = 'asc';
    }
    renderizarTabelaManifestos();
}

function renderizarTabelaManifestos() {
    const tbody = document.getElementById('audit-manifestos-tbody');
    tbody.innerHTML = '';
    
    // Ordenar
    const sorted = [...currentManifestos].sort((a, b) => {
        let valA = a[currentSort.field];
        let valB = b[currentSort.field];
        
        // Tratamento para null/undefined
        if (valA === null || valA === undefined) valA = '';
        if (valB === null || valB === undefined) valB = '';
        
        if (typeof valA === 'string') valA = valA.toLowerCase();
        if (typeof valB === 'string') valB = valB.toLowerCase();
        
        if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
        if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
        return 0;
    });

    sorted.forEach(m => {
        const custoMotorista = parseFloat(m.custo_motorista) || 0;
        const custoExtra = parseFloat(m.custo_motorista_extra) || 0;
        const adiantamento = parseFloat(m.adiantamento) || 0;
        const pedagio = parseFloat(m.pedagio) || 0;
        const picking = parseFloat(m.picking) || 0;
        
        const custoTotal = custoMotorista + custoExtra + adiantamento + pedagio + picking;
        
        const row = `
            <tr class="hover:bg-muted/30">
                <td class="px-4 py-3 text-sm font-medium">${m.id_manifesto}</td>
                <td class="px-4 py-3 text-sm" onclick="ordenarPor('data_emissao')">${formatDateBR(m.data_emissao)}</td>
                <td class="px-4 py-3 text-sm hidden md:table-cell" onclick="ordenarPor('tipo')">
                    <span class="rounded-full bg-primary/10 px-2 py-0.5 text-xs font-medium text-primary">
                        ${m.tipo_descricao || m.tipo || '-'}
                    </span>
                </td>
                <td class="px-4 py-3 text-sm hidden md:table-cell" onclick="ordenarPor('agente_nome')">${m.agente_nome || '-'}</td>
                <td class="px-4 py-3 text-sm" onclick="ordenarPor('motorista_nome')">${m.motorista_nome || '-'}</td>
                <td class="px-4 py-3 text-sm hidden md:table-cell">
                    ${m.veiculo_placa ? `<span class="font-mono">${m.veiculo_placa}</span><br><span class="text-xs text-muted-foreground">${m.veiculo_modelo || ''}</span>` : '-'}
                </td>
                <td class="px-4 py-3 text-sm text-muted-foreground hidden md:table-cell" onclick="ordenarPor('km_inicial')">${formatNumber(m.km_inicial)}</td>
                <td class="px-4 py-3 text-sm text-muted-foreground hidden md:table-cell" onclick="ordenarPor('km_final')">${formatNumber(m.km_final)}</td>
                <td class="px-4 py-3 text-sm font-medium hidden md:table-cell" onclick="ordenarPor('km_rodado')">${formatNumber(m.km_rodado)} km</td>
                <td class="px-4 py-3 text-sm font-medium text-green-600" onclick="ordenarPor('total_nf_valor')">${formatCurrency(m.total_nf_valor)}</td>
                <td class="px-4 py-3 text-sm">
                    <button onclick="mostrarCustosManifesto(${m.id_manifesto})" class="text-blue-500 hover:underline text-xs">
                        ${formatCurrency(custoTotal)}
                    </button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function mostrarCustosManifesto(manifestoId) {
    const manifesto = auditManifestos.find(m => m.id_manifesto == manifestoId);
    if (!manifesto) return;
    
    const content = `
        <div class="space-y-4">
            <!-- Dados Principais (Mobile) -->
            <div class="grid grid-cols-2 gap-4 md:hidden border-b pb-4">
                <div>
                    <p class="text-sm text-muted-foreground">Agente</p>
                    <p class="font-medium text-sm">${manifesto.agente_nome || '-'}</p>
                </div>
                <div>
                    <p class="text-sm text-muted-foreground">Veículo</p>
                    <p class="font-medium text-sm">${manifesto.veiculo_placa || '-'}</p>
                </div>
                 <div>
                    <p class="text-sm text-muted-foreground">Tipo</p>
                    <p class="font-medium text-sm">${manifesto.tipo_descricao || '-'}</p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <p class="text-sm text-muted-foreground">Custo Motorista</p>
                    <p class="font-medium">${formatCurrency(manifesto.custo_motorista)}</p>
                </div>
                <div>
                    <p class="text-sm text-muted-foreground">Custo Extra</p>
                    <p class="font-medium">${formatCurrency(manifesto.custo_motorista_extra)}</p>
                </div>
                <div>
                    <p class="text-sm text-muted-foreground">Adiantamento</p>
                    <p class="font-medium">${formatCurrency(manifesto.adiantamento)}</p>
                </div>
                <div>
                    <p class="text-sm text-muted-foreground">Pedágio</p>
                    <p class="font-medium">${formatCurrency(manifesto.pedagio)}</p>
                </div>
                <div>
                    <p class="text-sm text-muted-foreground">Picking</p>
                    <p class="font-medium">${formatCurrency(manifesto.picking)}</p>
                </div>
                <div>
                    <p class="text-sm text-muted-foreground">Fatura</p>
                    <p class="font-medium">${manifesto.fatura || '-'}</p>
                </div>
            </div>
            <div class="border-t pt-4">
                <p class="text-sm text-muted-foreground">Observações</p>
                <p class="text-sm">${manifesto.obs || 'Nenhuma observação'}</p>
            </div>
            <div class="grid grid-cols-3 gap-4 border-t pt-4">
                <div>
                    <p class="text-sm text-muted-foreground">KM Inicial</p>
                    <p class="font-medium">${formatNumber(manifesto.km_inicial)}</p>
                </div>
                <div>
                    <p class="text-sm text-muted-foreground">KM Final</p>
                    <p class="font-medium">${formatNumber(manifesto.km_final)}</p>
                </div>
                <div>
                    <p class="text-sm text-muted-foreground">KM Rodado</p>
                    <p class="font-medium">${formatNumber(manifesto.km_rodado)} km</p>
                </div>
            </div>
        </div>
    `;
    
    showModal(`Detalhes do Manifesto #${manifestoId}`, content);
}
function exportarExcel() {
    if (!currentManifestos || currentManifestos.length === 0) {
        alert("Não há dados para exportar.");
        return;
    }

    // Preparar dados para o Excel
    const dadosExcel = currentManifestos.map(m => ({
        "ID Manifesto": m.id_manifesto,
        "Data Emissão": formatDateBR(m.data_emissao),
        "Tipo": m.tipo_descricao || m.tipo || '-',
        "Agente": m.agente_nome || '-',
        "Motorista": m.motorista_nome || '-',
        "Veículo Placa": m.veiculo_placa || '-',
        "Veículo Modelo": m.veiculo_modelo || '-',
        "Operador": m.operador_nome || '-',
        "KM Inicial": m.km_inicial || 0,
        "KM Final": m.km_final || 0,
        "KM Rodado": m.km_rodado || 0,
        "Valor NF (R$)": m.total_nf_valor || 0,
        "Custo Motorista": m.custo_motorista || 0,
        "Custo Extra": m.custo_motorista_extra || 0,
        "Adiantamento": m.adiantamento || 0,
        "Pedágio": m.pedagio || 0,
        "Picking": m.picking || 0,
        "Fatura": m.fatura || '-'
    }));

    // Criar Worksheet
    const ws = XLSX.utils.json_to_sheet(dadosExcel);

    // Ajustar largura das colunas
    const colWidths = [
        { wch: 12 }, // ID
        { wch: 12 }, // Data
        { wch: 25 }, // Tipo
        { wch: 30 }, // Agente
        { wch: 30 }, // Motorista
        { wch: 10 }, // Placa
        { wch: 20 }, // Modelo
        { wch: 20 }, // Operador
        { wch: 10 }, // KM Ini
        { wch: 10 }, // KM Fim
        { wch: 10 }, // KM Rod
        { wch: 15 }, // Valor
        { wch: 12 }, // Custos...
        { wch: 12 },
        { wch: 12 },
        { wch: 10 },
        { wch: 10 },
        { wch: 15 }  // Fatura
    ];
    ws['!cols'] = colWidths;

    // Criar Workbook
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Manifestos");

    // Nome do arquivo
    const titleEl = document.getElementById('audit-detail-title');
    const operatorName = titleEl ? titleEl.innerText.split('(')[0].replace('Manifestos de', '').trim() : 'Relatorio';
    // Remove caracteres inválidos para nome de arquivo
    const safeName = operatorName.replace(/[^a-z0-9]/gi, '_').replace(/_+/g, '_');
    const fileName = `Manifestos_${safeName}_${new Date().toISOString().split('T')[0]}.xlsx`;

    // Download
    XLSX.writeFile(wb, fileName);
}

function insertCommand(command) {
    const chatInput = document.getElementById('chat-input');
    if (chatInput) {
        chatInput.value = command;
        chatInput.focus();
    }
}

function exportChatToExcel() {
    const messagesContainer = document.getElementById('chat-messages');
    if (!messagesContainer) return;
    
    const messageDivs = messagesContainer.querySelectorAll('.flex.items-start');
    if (messageDivs.length === 0) {
        alert('Não há mensagens para exportar.');
        return;
    }

    const data = [];
    messageDivs.forEach(msg => {
        // Tenta identificar se é bot ou usuário pelo avatar ou classes
        const isBot = msg.querySelector('img[alt="AI"]') !== null || msg.querySelector('.fa-robot') !== null;
        const role = isBot ? 'Assistente' : 'Usuário';
        
        // Pega o texto
        const textElement = msg.querySelector('.rounded-2xl, .rounded-lg');
        let content = textElement ? textElement.innerText.trim() : '';
        
        // Limpa quebras de linha excessivas
        content = content.replace(/\n+/g, '\n');

        data.push({
            "Papel": role,
            "Mensagem": content,
            "Data Exportação": new Date().toLocaleString()
        });
    });

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Chat Histórico");
    
    // Ajustar colunas
    ws['!cols'] = [{ wch: 15 }, { wch: 80 }, { wch: 20 }];
    
    XLSX.writeFile(wb, `GeRot_Chat_${new Date().toISOString().slice(0,10)}.xlsx`);
}
</script>
{% endblock %}
