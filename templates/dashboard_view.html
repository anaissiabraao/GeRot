{% extends "base_tailwind.html" %}

{% block title %}{{ template.title }} - GeRot{% endblock %}

{% block content %}
<div class="min-h-screen bg-background">
    <!-- Header -->
    <header class="sticky top-0 z-40 border-b bg-card/95 backdrop-blur supports-[backdrop-filter]:bg-card/60">
        <div class="container mx-auto flex h-14 items-center justify-between px-4">
            <div class="flex items-center gap-4">
                <a href="{{ url_for('agent_page') }}" class="flex items-center gap-2 text-muted-foreground hover:text-foreground">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <div>
                    <h1 class="text-lg font-semibold">{{ template.title }}</h1>
                    <span class="text-xs text-muted-foreground">{{ template.category }}</span>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="refreshData()" class="rounded-md border px-3 py-1.5 text-sm font-medium hover:bg-muted/50 transition-colors">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Atualizar
                </button>
                <a href="{{ url_for('dashboard_editor', template_id=template.id) }}" 
                   class="rounded-md border px-3 py-1.5 text-sm font-medium hover:bg-muted/50 transition-colors">
                    <i class="fas fa-edit mr-2"></i>
                    Editar
                </a>
            </div>
        </div>
    </header>

    <!-- Dashboard Canvas -->
    <main class="container mx-auto px-4 py-6">
        <div id="dashboardCanvas" class="grid grid-cols-12 gap-4 auto-rows-min">
            <!-- Componentes serão renderizados aqui -->
        </div>
    </main>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const templateConfig = {
    id: {{ template.id }},
    queryConfig: {{ template.query_config | tojson if template.query_config else '{}' }},
    chartsConfig: {{ template.charts_config | tojson if template.charts_config else '[]' }}
};

let dashboardData = [];
let chartInstances = {};

document.addEventListener('DOMContentLoaded', async () => {
    await loadData();
    renderDashboard();
});

async function loadData() {
    const query = templateConfig.queryConfig.query;
    if (!query) return;
    
    try {
        const response = await fetch('/api/agent/dashboard-editor/execute-query', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query })
        });
        
        const result = await response.json();
        if (result.data) {
            dashboardData = result.data;
        }
    } catch (error) {
        console.error('Erro ao carregar dados:', error);
    }
}

function renderDashboard() {
    const canvas = document.getElementById('dashboardCanvas');
    canvas.innerHTML = '';
    
    if (templateConfig.chartsConfig.length === 0) {
        canvas.innerHTML = `
            <div class="col-span-12 text-center py-20">
                <i class="fas fa-chart-bar text-4xl text-muted-foreground mb-4"></i>
                <p class="text-muted-foreground">Este dashboard não possui componentes configurados</p>
            </div>
        `;
        return;
    }
    
    templateConfig.chartsConfig.forEach(config => {
        renderComponent(config);
    });
}

function renderComponent(config) {
    const canvas = document.getElementById('dashboardCanvas');
    
    const wrapper = document.createElement('div');
    wrapper.className = `col-span-${config.colSpan || 6} bg-card rounded-lg border shadow-sm overflow-hidden`;
    wrapper.style.minHeight = config.type === 'kpi' ? '120px' : '300px';
    
    wrapper.innerHTML = `
        <div class="flex items-center justify-between px-4 py-2 border-b bg-muted/30">
            <span class="text-sm font-medium">${config.title}</span>
        </div>
        <div class="p-4 h-full" id="content_${config.id}">
            ${config.type === 'table' ? '<div id="table_' + config.id + '"></div>' : 
              config.type === 'kpi' ? '<div id="kpi_' + config.id + '" class="text-center py-4"></div>' :
              '<canvas id="canvas_' + config.id + '"></canvas>'}
        </div>
    `;
    
    canvas.appendChild(wrapper);
    
    // Renderizar conteúdo
    setTimeout(() => {
        if (config.type === 'table') {
            renderTable(config);
        } else if (config.type === 'kpi') {
            renderKPI(config);
        } else {
            renderChart(config);
        }
    }, 100);
}

function renderChart(config) {
    const ctx = document.getElementById(`canvas_${config.id}`);
    if (!ctx || !dashboardData.length) return;
    
    const aggregated = aggregateData(config);
    
    const chartConfig = {
        type: config.type === 'doughnut' ? 'doughnut' : config.type,
        data: {
            labels: aggregated.labels,
            datasets: [{
                label: config.title,
                data: aggregated.values,
                backgroundColor: config.colors || ['#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899'],
                borderColor: config.colors || ['#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: ['pie', 'doughnut'].includes(config.type)
                }
            }
        }
    };
    
    chartInstances[config.id] = new Chart(ctx, chartConfig);
}

function aggregateData(config) {
    const fields = dashboardData.length > 0 ? Object.keys(dashboardData[0]) : [];
    const xField = config.xField || fields[0];
    const yField = config.yField;
    
    const groups = {};
    dashboardData.forEach(row => {
        const key = row[xField] || 'N/A';
        if (!groups[key]) groups[key] = [];
        groups[key].push(yField ? parseFloat(row[yField]) || 0 : 1);
    });
    
    const labels = Object.keys(groups).slice(0, 10);
    const values = labels.map(key => {
        const arr = groups[key];
        switch (config.aggregation) {
            case 'sum': return arr.reduce((a, b) => a + b, 0);
            case 'avg': return arr.reduce((a, b) => a + b, 0) / arr.length;
            case 'min': return Math.min(...arr);
            case 'max': return Math.max(...arr);
            default: return arr.length;
        }
    });
    
    return { labels, values };
}

function renderTable(config) {
    const container = document.getElementById(`table_${config.id}`);
    if (!container || !dashboardData.length) return;
    
    const fields = Object.keys(dashboardData[0]).slice(0, 6);
    const rows = dashboardData.slice(0, 20);
    
    container.innerHTML = `
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-muted/50">
                    <tr>
                        ${fields.map(f => `<th class="px-3 py-2 text-left text-xs font-medium uppercase">${f}</th>`).join('')}
                    </tr>
                </thead>
                <tbody class="divide-y">
                    ${rows.map(row => `
                        <tr class="hover:bg-muted/30">
                            ${fields.map(f => `<td class="px-3 py-2 whitespace-nowrap">${row[f] || ''}</td>`).join('')}
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        ${dashboardData.length > 20 ? `<p class="text-xs text-muted-foreground text-center mt-2">Mostrando 20 de ${dashboardData.length} registros</p>` : ''}
    `;
}

function renderKPI(config) {
    const container = document.getElementById(`kpi_${config.id}`);
    if (!container) return;
    
    let value = dashboardData.length;
    if (config.yField && dashboardData.length > 0) {
        const values = dashboardData.map(r => parseFloat(r[config.yField]) || 0);
        switch (config.aggregation) {
            case 'sum': value = values.reduce((a, b) => a + b, 0); break;
            case 'avg': value = values.reduce((a, b) => a + b, 0) / values.length; break;
            case 'min': value = Math.min(...values); break;
            case 'max': value = Math.max(...values); break;
            default: value = values.length;
        }
    }
    
    container.innerHTML = `
        <div class="text-4xl font-bold text-primary">${typeof value === 'number' ? value.toLocaleString('pt-BR') : value}</div>
        <div class="text-sm text-muted-foreground mt-1">${config.title}</div>
    `;
}

async function refreshData() {
    // Destruir gráficos existentes
    Object.values(chartInstances).forEach(chart => chart.destroy());
    chartInstances = {};
    
    await loadData();
    renderDashboard();
}
</script>
{% endblock %}
