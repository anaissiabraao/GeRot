{% extends "base.html" %}

{% block title %}Visualização 3D do CD - GeRot{% endblock %}

{% block extra_css %}
<style>
    .facilities-container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 2rem;
    }
    
    .facilities-header {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        padding: 2.5rem;
        border-radius: 15px;
        color: white;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .facilities-header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .facilities-header p {
        opacity: 0.95;
        font-size: 1.1rem;
    }
    
    .header-actions {
        margin-top: 1.5rem;
        display: flex;
        gap: 1rem;
    }
    
    .header-btn {
        padding: 0.75rem 1.5rem;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s;
    }
    
    .header-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
    }
    
    .environment-selector {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .environment-selector h2 {
        font-size: 1.3rem;
        margin-bottom: 1rem;
        color: #1e3c72;
    }
    
    .environment-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .env-button {
        padding: 1rem;
        border: 2px solid #e0e0e0;
        background: white;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
    }
    
    .env-button:hover {
        border-color: #1e3c72;
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(30, 60, 114, 0.15);
    }
    
    .env-button.active {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        border-color: #1e3c72;
    }
    
    .env-button i {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        display: block;
    }
    
    .env-button .env-name {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    
    .env-button .env-info {
        font-size: 0.85rem;
        opacity: 0.8;
    }
    
    .viewer-section {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .viewer-tabs {
        display: flex;
        background: #f8f9fa;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .viewer-tab {
        flex: 1;
        padding: 1rem 2rem;
        background: none;
        border: none;
        cursor: pointer;
        font-weight: 600;
        color: #6b7280;
        transition: all 0.3s;
        position: relative;
    }
    
    .viewer-tab:hover {
        background: #f3f4f6;
        color: #374151;
    }
    
    .viewer-tab.active {
        background: white;
        color: #1e3c72;
    }
    
    .viewer-tab.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 2px;
        background: #1e3c72;
    }
    
    .viewer-content {
        display: none;
        padding: 2rem;
    }
    
    .viewer-content.active {
        display: block;
    }
    
    #viewer3d-container {
        position: relative;
        width: 100%;
        height: 700px;
        background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
        border-radius: 10px;
        overflow: hidden;
    }
    
    #viewer3d {
        width: 100%;
        height: 100%;
    }
    
    #viewer2d {
        width: 100%;
        height: 700px;
        background: #f8f9fa;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
    }
    
    .plant-image {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        cursor: grab;
    }
    
    .plant-image.dragging {
        cursor: grabbing;
    }
    
    .no-content-message {
        text-align: center;
        padding: 3rem;
        color: #6b7280;
    }
    
    .no-content-message i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    .viewer-controls {
        margin-top: 1.5rem;
        padding: 1.5rem;
        background: #f9fafb;
        border-radius: 10px;
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .control-btn {
        padding: 0.75rem 1.25rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .control-btn.primary {
        background: #2563eb;
        color: white;
    }
    
    .control-btn.primary:hover {
        background: #1d4ed8;
    }
    
    .control-btn.secondary {
        background: #6b7280;
        color: white;
    }
    
    .control-btn.secondary:hover {
        background: #4b5563;
    }
    
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(15, 15, 35, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        z-index: 100;
    }
    
    .loading-overlay div {
        text-align: center;
    }
    
    .loading-overlay i {
        font-size: 3rem;
        margin-bottom: 1rem;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="facilities-container">
    <!-- Header -->
    <div class="facilities-header">
        <h1>
            <i class="fas fa-cube"></i>
            Visualização 3D do Centro de Distribuição
        </h1>
        <p>Explore o layout completo do CD através de modelos 3D interativos e plantas detalhadas</p>
        <div class="header-actions">
            <a href="/cd/booking" class="header-btn">
                <i class="fas fa-calendar-plus"></i>
                Agendar Sala
            </a>
            {% if session.role == 'manager' %}
            <a href="/admin/dashboard#facilities" class="header-btn">
                <i class="fas fa-cog"></i>
                Configurar Ambientes
            </a>
            {% endif %}
        </div>
    </div>
    
    <!-- Environment Selector -->
    <div class="environment-selector">
        <h2>
            <i class="fas fa-th-large"></i>
            Selecione o Ambiente
        </h2>
        <div class="environment-grid" id="environmentGrid">
            {% for env in environments %}
            <button class="env-button {% if loop.first %}active{% endif %}" 
                    data-env="{{ env.code }}" 
                    data-id="{{ env.id }}"
                    onclick="selectEnvironment('{{ env.code }}')">
                <i class="{{ env.icon or 'fas fa-cube' }}"></i>
                <div class="env-name">{{ env.name }}</div>
                <div class="env-info">{{ env.description or '' }}</div>
            </button>
            {% endfor %}
            
            {% if not environments %}
            <div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: #6b7280;">
                <p>Nenhum ambiente cadastrado.</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Viewer Section -->
    <div class="viewer-section">
        <div class="viewer-tabs">
            <button class="viewer-tab active" onclick="switchViewMode('3d')">
                <i class="fas fa-cube"></i>
                Modelo 3D
            </button>
            <button class="viewer-tab" onclick="switchViewMode('2d')">
                <i class="fas fa-map"></i>
                Planta 2D
            </button>
            <button class="viewer-tab" onclick="switchViewMode('photos')">
                <i class="fas fa-images"></i>
                Fotos
            </button>
        </div>
        
        <!-- 3D View -->
        <div id="view-3d" class="viewer-content active">
            <div id="viewer3d-container">
                <div class="loading-overlay" id="loadingOverlay3d">
                    <div>
                        <i class="fas fa-spinner"></i>
                        <p>Carregando modelo 3D...</p>
                    </div>
                </div>
                <div id="viewer3d"></div>
            </div>
            
            <div class="viewer-controls">
                <button class="control-btn primary" onclick="resetCamera()">
                    <i class="fas fa-redo"></i> Resetar Câmera
                </button>
                <button class="control-btn secondary" onclick="toggleWireframe()">
                    <i class="fas fa-border-all"></i> Wireframe
                </button>
                <button class="control-btn secondary" onclick="switchModel()">
                    <i class="fas fa-exchange-alt"></i> Alternar Modelo
                </button>
                <div style="flex: 1;"></div>
                <span style="color: #6b7280;">
                    <i class="fas fa-mouse"></i> Arraste para rotacionar | 
                    <i class="fas fa-search-plus"></i> Scroll para zoom
                </span>
            </div>
        </div>
        
        <!-- 2D View -->
        <div id="view-2d" class="viewer-content">
            <div id="viewer2d">
                <div class="no-content-message" id="no2dContent">
                    <i class="fas fa-map-marked-alt"></i>
                    <h3>Planta 2D não disponível</h3>
                    <p>Nenhuma planta foi carregada para este ambiente.</p>
                    {% if session.role == 'manager' %}
                    <a href="/admin/dashboard#facilities" class="control-btn primary" style="margin-top: 1rem;">
                        <i class="fas fa-upload"></i> Fazer Upload
                    </a>
                    {% endif %}
                </div>
                <img id="plantImage" class="plant-image" style="display: none;" alt="Planta 2D">
            </div>
            
            <div class="viewer-controls">
                <button class="control-btn primary" onclick="resetZoom()">
                    <i class="fas fa-compress"></i> Ajustar Zoom
                </button>
                <button class="control-btn secondary" onclick="downloadPlant()">
                    <i class="fas fa-download"></i> Baixar Planta
                </button>
            </div>
        </div>
        
        <!-- Photos View -->
        <div id="view-photos" class="viewer-content">
            <div id="photosGallery" style="padding: 2rem;">
                <div class="no-content-message">
                    <i class="fas fa-camera"></i>
                    <h3>Fotos não disponíveis</h3>
                    <p>Nenhuma foto foi carregada para este ambiente.</p>
                    {% if session.role == 'manager' %}
                    <a href="/admin/dashboard#facilities" class="control-btn primary" style="margin-top: 1rem;">
                        <i class="fas fa-upload"></i> Fazer Upload
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script type="importmap">
{
    "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
    }
}
</script>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';

    let scene, camera, renderer, controls, currentModel;
    let currentModelType = 'glb';
    let wireframeMode = false;
    let currentEnvironment = 'geral';

    function initViewer() {
        const container = document.getElementById('viewer3d');
        
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a2e);
        
        camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.set(5, 5, 5);
        
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.shadowMap.enabled = true;
        container.appendChild(renderer.domElement);
        
        controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(10, 10, 5);
        directionalLight.castShadow = true;
        scene.add(directionalLight);
        
        const gridHelper = new THREE.GridHelper(20, 20);
        scene.add(gridHelper);
        
        loadModel('glb');
        
        animate();
        
        window.addEventListener('resize', onWindowResize);
    }

    function loadModel(type) {
        const loadingOverlay = document.getElementById('loadingOverlay3d');
        loadingOverlay.style.display = 'flex';
        
        if (currentModel) {
            scene.remove(currentModel);
        }
        
        currentModelType = type;
        
        if (type === 'glb') {
            const loader = new GLTFLoader();
            loader.load(
                '/api/3d-model/glb',
                function(gltf) {
                    currentModel = gltf.scene;
                    scene.add(currentModel);
                    
                    currentModel.traverse((child) => {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                        }
                    });
                    
                    const box = new THREE.Box3().setFromObject(currentModel);
                    const center = box.getCenter(new THREE.Vector3());
                    currentModel.position.sub(center);
                    
                    loadingOverlay.style.display = 'none';
                },
                function(xhr) {
                    console.log((xhr.loaded / xhr.total * 100) + '% loaded');
                },
                function(error) {
                    console.error('Erro ao carregar GLB:', error);
                    loadingOverlay.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #f59e0b;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <h3 style="margin-bottom: 1rem;">Modelo 3D não encontrado</h3>
                            <p style="color: #9ca3af;">Verifique se o arquivo foi configurado corretamente.</p>
                        </div>
                    `;
                }
            );
        } else {
            const loader = new FBXLoader();
            loader.load(
                '/api/3d-model/fbx',
                function(fbx) {
                    currentModel = fbx;
                    scene.add(currentModel);
                    
                    currentModel.traverse((child) => {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                        }
                    });
                    
                    currentModel.scale.set(0.01, 0.01, 0.01);
                    
                    loadingOverlay.style.display = 'none';
                },
                function(xhr) {
                    console.log((xhr.loaded / xhr.total * 100) + '% loaded');
                },
                function(error) {
                    console.error('Erro ao carregar FBX:', error);
                    loadingOverlay.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #f59e0b;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <h3 style="margin-bottom: 1rem;">Modelo 3D não encontrado</h3>
                            <p style="color: #9ca3af;">Verifique se o arquivo foi configurado corretamente.</p>
                        </div>
                    `;
                }
            );
        }
    }

    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }

    function onWindowResize() {
        const container = document.getElementById('viewer3d');
        if (container && camera && renderer) {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }
    }

    window.resetCamera = function() {
        if (camera && controls) {
            camera.position.set(5, 5, 5);
            controls.reset();
        }
    }

    window.toggleWireframe = function() {
        wireframeMode = !wireframeMode;
        if (currentModel) {
            currentModel.traverse((child) => {
                if (child.isMesh) {
                    child.material.wireframe = wireframeMode;
                }
            });
        }
    }

    window.switchModel = function() {
        // Esta função alterna entre formatos se disponíveis
        // Por enquanto, vamos apenas recarregar o atual
        const env = environmentsData.find(e => e.code === currentEnvironment);
        if (env) {
            loadEnvironmentContent(env.code);
        }
    }

    // Initialize viewer when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initViewer);
    } else {
        initViewer();
    }
</script>

<script>
    // Dados dos ambientes injetados pelo backend
    const environmentsData = {{ environments | tojson | safe }};

    // Environment selection
    function selectEnvironment(envCode) {
        currentEnvironment = envCode;
        
        // Update active button
        document.querySelectorAll('.env-button').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.env === envCode) {
                btn.classList.add('active');
            }
        });
        
        // Load environment-specific content
        loadEnvironmentContent(envCode);
    }
    
    function loadEnvironmentContent(envCode) {
        console.log('Loading environment:', envCode);
        const env = environmentsData.find(e => e.code === envCode);
        
        if (!env) {
            console.error('Ambiente não encontrado:', envCode);
            return;
        }
        
        // Encontrar recursos
        const models = env.resources.filter(r => r.resource_type === 'model_3d');
        const plants = env.resources.filter(r => r.resource_type === 'plant_2d');
        // const photos = env.resources.filter(r => r.resource_type === 'photo');
        
        // Carregar Modelo 3D
        if (models.length > 0) {
            // Usa o primeiro modelo encontrado (priorizando is_primary se ordenado)
            const modelUrl = models[0].file_url;
            const isGlb = modelUrl.toLowerCase().endsWith('.glb') || modelUrl.toLowerCase().endsWith('.gltf');
            loadModel(isGlb ? 'glb' : 'fbx', modelUrl);
        } else {
            // Se não tiver modelo, tentar carregar o padrão (proxy)
            // loadModel('glb', '/api/3d-model/glb');
            console.log('Nenhum modelo 3D específico encontrado para este ambiente');
            // Opcional: Limpar a cena ou mostrar placeholder
        }
        
        // Carregar Planta 2D
        const plantImg = document.getElementById('plantImage');
        if (plantImg) {
            if (plants.length > 0) {
                plantImg.src = plants[0].file_url;
                plantImg.style.display = 'block';
            } else {
                // Placeholder se não tiver planta
                plantImg.src = '/static/img/blueprint-placeholder.jpg'; 
                // Ou esconder: plantImg.style.display = 'none';
            }
        }
    }
    
    // Atualizar loadModel para aceitar URL
    function loadModel(type, url) {
        const loadingOverlay = document.getElementById('loadingOverlay3d');
        if (loadingOverlay) loadingOverlay.style.display = 'flex';
        
        if (currentModel) {
            scene.remove(currentModel);
            currentModel = null;
        }
        
        currentModelType = type;
        
        // Se não passar URL, usar as rotas de proxy padrão (fallback)
        const modelUrl = url || (type === 'glb' ? '/api/3d-model/glb' : '/api/3d-model/fbx');
        
        if (type === 'glb') {
            const loader = new GLTFLoader();
            loader.load(
                modelUrl,
                function(gltf) {
                    currentModel = gltf.scene;
                    scene.add(currentModel);
                    
                    currentModel.traverse((child) => {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                        }
                    });
                    
                    // Centralizar e ajustar escala
                    const box = new THREE.Box3().setFromObject(currentModel);
                    const center = box.getCenter(new THREE.Vector3());
                    currentModel.position.sub(center);
                    
                    if (loadingOverlay) loadingOverlay.style.display = 'none';
                },
                function(xhr) {
                    // console.log((xhr.loaded / xhr.total * 100) + '% loaded');
                },
                function(error) {
                    console.error('Erro ao carregar GLB:', error);
                    if (loadingOverlay) {
                        loadingOverlay.innerHTML = `
                            <div style="text-align: center; padding: 2rem; color: #f59e0b;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                <h3 style="margin-bottom: 1rem;">Modelo 3D não encontrado</h3>
                                <p style="color: #9ca3af;">Não há modelo 3D disponível para este ambiente.</p>
                            </div>
                        `;
                    }
                }
            );
        } else {
            const loader = new FBXLoader();
            loader.load(
                modelUrl,
                function(fbx) {
                    currentModel = fbx;
                    scene.add(currentModel);
                    
                    currentModel.traverse((child) => {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                        }
                    });
                    
                    currentModel.scale.set(0.01, 0.01, 0.01);
                    
                    if (loadingOverlay) loadingOverlay.style.display = 'none';
                },
                function(xhr) {
                    // console.log((xhr.loaded / xhr.total * 100) + '% loaded');
                },
                function(error) {
                    console.error('Erro ao carregar FBX:', error);
                    if (loadingOverlay) {
                        loadingOverlay.innerHTML = `
                            <div style="text-align: center; padding: 2rem; color: #f59e0b;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                <h3 style="margin-bottom: 1rem;">Modelo 3D não encontrado</h3>
                                <p style="color: #9ca3af;">Não há modelo 3D disponível para este ambiente.</p>
                            </div>
                        `;
                    }
                }
            );
        }
    }
    
    // View mode switching
    function switchViewMode(mode) {
        // Update tabs
        document.querySelectorAll('.viewer-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Update content
        document.querySelectorAll('.viewer-content').forEach(content => {
            content.classList.remove('active');
        });
        
        if (mode === '3d') {
            document.getElementById('view-3d').classList.add('active');
        } else if (mode === '2d') {
            document.getElementById('view-2d').classList.add('active');
        } else if (mode === 'photos') {
            document.getElementById('view-photos').classList.add('active');
        }
    }
    
    // 2D Plant functions
    function resetZoom() {
        const img = document.getElementById('plantImage');
        if (img) {
            img.style.transform = 'scale(1)';
        }
    }
    
    function downloadPlant() {
        const img = document.getElementById('plantImage');
        if (img && img.src) {
            const a = document.createElement('a');
            a.href = img.src;
            a.download = `planta_${currentEnvironment}.jpg`;
            a.click();
        }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Load default environment (first one or 'geral')
        if (environmentsData && environmentsData.length > 0) {
            selectEnvironment(environmentsData[0].code);
        }
    });
</script>
{% endblock %}
